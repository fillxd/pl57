<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöå System Przystank√≥w Autobusowych</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .setup-screen, .running-screen {
            display: none;
            animation: fadeIn 0.5s;
        }

        .setup-screen.active, .running-screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes ledGlow {
            0%, 100% { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
            50% { text-shadow: 0 0 20px currentColor, 0 0 40px currentColor; }
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes expandHeight {
            from { max-height: 0; opacity: 0; }
            to { max-height: 2000px; opacity: 1; }
        }

        @keyframes collapseHeight {
            from { max-height: 2000px; opacity: 1; }
            to { max-height: 0; opacity: 0; }
        }

        .card {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
        }

        h2 {
            margin-bottom: 20px;
            color: #4CAF50;
            font-size: 1.5em;
        }

        /* ZEGAR W LEWYM G√ìRNYM ROGU */
        .live-clock {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border: 2px solid rgba(76, 175, 80, 0.3);
        }

        .clock-date {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        /* NOWY: PRZYCISK DODAWANIA */
        .add-route-btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .add-route-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .add-route-btn.active {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }

        /* NOWY INTERFEJS DODAWANIA PRZYSTANK√ìW - UKRYTY DOMY≈öLNIE */
        .quick-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.4s ease-out;
            overflow: hidden;
        }

        .quick-add.active {
            display: block;
        }

        .quick-add h3 {
            margin-bottom: 15px;
            color: #fff;
        }

        .input-group {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
        }

        input, select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #03A9F4);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #e91e63);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #FFC107);
            color: white;
        }

        .btn-icon {
            width: 45px;
            height: 45px;
            padding: 0;
            font-size: 20px;
            border-radius: 50%;
        }

        /* LISTA PRZYSTANK√ìW Z DRAG & DROP */
        .stops-editor {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            min-height: 100px;
        }

        .stop-item {
            background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            cursor: move;
            transition: all 0.3s;
            border-left: 4px solid #4CAF50;
            animation: slideIn 0.3s;
        }

        .stop-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .stop-item.dragging {
            opacity: 0.5;
        }

        .stop-number {
            background: #4CAF50;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .stop-info {
            display: flex;
            flex-direction: column;
        }

        .stop-name {
            font-weight: bold;
            font-size: 16px;
        }

        .stop-time {
            font-size: 12px;
            color: #aaa;
        }

        .stop-duration {
            background: rgba(33, 150, 243, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #2196F3;
            font-weight: bold;
        }

        /* ============================================ */
        /* NOWY SYSTEM GRUPOWANIA LINII */
        /* ============================================ */

        .groups-container {
            margin-bottom: 20px;
        }

        .group-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
        }

        .group-controls input {
            flex: 1;
        }

        /* DRZEWO GRUP I LINII */
        .tree-view {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 10px;
            margin-top: 15px;
        }

        .tree-item {
            margin-bottom: 5px;
        }

        .tree-folder {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 193, 7, 0.1));
            border-left: 4px solid #FF9800;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            animation: slideDown 0.3s;
        }

        .tree-folder.level-1 {
            border-left-color: #FF9800;
        }

        .tree-folder.level-2 {
            border-left-color: #2196F3;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(3, 169, 244, 0.1));
        }

        .tree-folder.level-3 {
            border-left-color: #9C27B0;
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(142, 36, 170, 0.1));
        }

        .folder-header {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto auto;
            gap: 10px;
            padding: 12px 15px;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .folder-toggle {
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }

        .folder-toggle.expanded {
            transform: rotate(90deg);
        }

        .folder-icon {
            font-size: 24px;
        }

        .folder-name {
            font-weight: bold;
            font-size: 16px;
            flex: 1;
        }

        .folder-count {
            background: rgba(255,255,255,0.15);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .folder-actions {
            display: flex;
            gap: 5px;
        }

        .folder-actions button {
            width: 35px;
            height: 35px;
            padding: 0;
            font-size: 16px;
            border-radius: 50%;
        }

        .folder-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s;
            opacity: 0;
            padding: 0 15px;
        }

        .folder-content.expanded {
            max-height: 5000px;
            opacity: 1;
            padding: 10px 15px 15px 15px;
        }

        .folder-children {
            margin-left: 20px;
            border-left: 2px dashed rgba(255,255,255,0.1);
            padding-left: 15px;
        }

        /* LINIA W DRZEWIE */
        .tree-route {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(139, 195, 74, 0.05));
            border-left: 4px solid #4CAF50;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            transition: all 0.3s;
            animation: slideDown 0.3s;
        }

        .tree-route:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .route-tree-header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .route-tree-info {
            display: flex;
            flex-direction: column;
        }

        .route-tree-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .route-tree-details {
            font-size: 12px;
            color: #aaa;
        }

        .route-tree-actions {
            display: flex;
            gap: 5px;
        }

        .route-tree-actions button {
            width: 35px;
            height: 35px;
            padding: 0;
            font-size: 14px;
            border-radius: 50%;
        }

        /* ============================================ */
        /* EKRAN DZIA≈ÅANIA - NOWY LAYOUT 2-KOLUMNOWY */
        /* ============================================ */
        
        .running-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 40px);
            max-height: 1000px;
        }

        .main-display-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Scrollbar styling */
        .sidebar-column::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-column::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .sidebar-column::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 10px;
        }

        .sidebar-column::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.8);
        }

        .bus-display {
            background: #000;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 50px rgba(255, 165, 0, 0.3), inset 0 0 20px rgba(255,255,255,0.1);
            border: 3px solid #333;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        /* ETA BADGE */
        .eta-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
        }

        .eta-label {
            font-size: 10px;
            color: #ddd;
            text-transform: uppercase;
        }

        .eta-time {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
        }

        .line-info {
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            color: #FFA500;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .next-stop-label {
            text-align: center;
            font-size: 18px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .current-stop {
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-size: 56px;
            font-weight: 900;
            margin: 20px 0;
            text-transform: uppercase;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .timer-container {
            position: relative;
            margin: 30px 0;
        }

        .timer {
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-size: 90px;
            font-weight: 900;
            padding: 40px;
            border-radius: 20px;
            transition: all 0.5s;
            letter-spacing: 10px;
            text-shadow: 0 0 30px currentColor;
            position: relative;
        }

        .timer::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: inherit;
            filter: blur(20px);
            opacity: 0.5;
            z-index: -1;
            border-radius: 20px;
        }

        .delay-indicator {
            text-align: center;
            font-size: 24px;
            margin-top: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* STATUS BAR - teraz w sidebarze */
        .status-bar {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .status-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .status-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
            font-family: 'Orbitron', monospace;
        }

        /* CONTROLS - NOWY UK≈ÅAD Z STRZA≈ÅKAMI */
        .controls {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
            gap: 15px;
        }

        .controls button {
            padding: 20px;
            font-size: 18px;
        }

        .controls .btn-icon {
            width: 60px;
            height: 60px;
            font-size: 24px;
            border-radius: 50%;
        }

        /* PROGRESS BAR */
        .route-progress {
            background: rgba(0,0,0,0.3);
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
        }

        .route-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s;
            box-shadow: 0 0 10px #4CAF50;
        }

        /* ROZK≈ÅAD JAZDY - kompaktowy w sidebarze */
        .schedule-container {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .schedule-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(76, 175, 80, 0.3);
        }

        .schedule-list {
            overflow-y: auto;
            flex: 1;
            padding-right: 5px;
            scroll-behavior: smooth;
        }

        .schedule-list::-webkit-scrollbar {
            width: 6px;
        }

        .schedule-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .schedule-list::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 10px;
        }

        .schedule-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            border-left: 3px solid #666;
            transition: all 0.3s;
            animation: slideDown 0.3s;
        }

        .schedule-item.current {
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.3), rgba(76, 175, 80, 0.1));
            border-left-color: #4CAF50;
        }

        .schedule-item.passed {
            opacity: 0.4;
        }

        .schedule-item.next {
            background: rgba(255, 165, 0, 0.1);
            border-left-color: #FFA500;
        }

        .schedule-stop-number {
            background: rgba(255,255,255,0.1);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        .schedule-item.current .schedule-stop-number {
            background: #4CAF50;
        }

        .schedule-stop-info {
            display: flex;
            flex-direction: column;
        }

        .schedule-stop-name {
            font-weight: bold;
            font-size: 14px;
        }

        .schedule-stop-time {
            font-size: 11px;
            color: #888;
        }

        .schedule-time-info {
            text-align: right;
        }

        .schedule-time {
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            font-weight: bold;
        }

        .estimated-time {
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            color: #FFA500;
            margin-top: 3px;
        }

        .delay-badge {
            grid-column: 2 / 4;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
        }

        .delay-badge.on-time {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .delay-badge.early {
            background: rgba(33, 150, 243, 0.3);
            color: #2196F3;
        }

        .delay-badge.late {
            background: rgba(255, 152, 0, 0.3);
            color: #FF9800;
        }

        .delay-badge.very-late {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        /* ROUTE CARDS - STARE (do usuniƒôcia w nastƒôpnej wersji, zostajƒÖ dla kompatybilno≈õci) */
        .route-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            animation: slideIn 0.3s;
        }

        .route-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-title {
            font-size: 24px;
            font-weight: bold;
        }

        .route-badge {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .route-details {
            color: #aaa;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .route-stops-preview {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stop-chip {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .route-actions {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.3s;
        }

        .time-picker {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
        }

        .time-picker input {
            font-size: 48px;
            text-align: center;
            font-family: 'Orbitron', monospace;
            padding: 20px;
        }

        .time-separator {
            font-size: 48px;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        /* Keyboard hint */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            z-index: 999;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
		        /* ============================================ */
        /* WYSZUKIWARKI */
        /* ============================================ */

        .search-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .search-box {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
        }

        .search-box:last-of-type {
            margin-bottom: 0;
        }

        .search-box input {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            background: rgba(255,255,255,0.15);
            border-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .search-box input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-results {
            margin-top: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .search-results.active {
            max-height: 500px;
            overflow-y: auto;
            padding-top: 15px;
            border-top: 2px solid rgba(76, 175, 80, 0.3);
        }

        .search-result-item {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(139, 195, 74, 0.1));
            border-left: 4px solid #4CAF50;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            animation: slideDown 0.3s;
        }

        .search-result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(139, 195, 74, 0.2));
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .search-result-title {
            font-weight: bold;
            font-size: 16px;
            color: #4CAF50;
        }

        .search-result-badge {
            background: rgba(76, 175, 80, 0.3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .search-result-details {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .search-result-path {
            font-size: 11px;
            color: #888;
            font-style: italic;
        }

        .search-result-stops {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .search-stop-chip {
            background: rgba(255,255,255,0.1);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .search-stop-chip.highlight {
            background: rgba(255, 193, 7, 0.4);
            color: #FFC107;
            font-weight: bold;
        }

        .no-results {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .running-layout {
                grid-template-columns: 1fr 350px;
            }
            
            .timer {
                font-size: 70px;
                padding: 30px;
            }
            
            .current-stop {
                font-size: 42px;
            }

            .live-clock {
                font-size: 20px;
                padding: 10px 15px;
            }
        }

        @media (max-width: 968px) {
            .running-layout {
                grid-template-columns: 1fr;
                height: auto;
                max-height: none;
            }
            
            .sidebar-column {
                max-height: 500px;
            }
            
            .timer {
                font-size: 55px;
                padding: 30px;
            }
            
            .current-stop {
                font-size: 36px;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }

            .keyboard-hint {
                bottom: 10px;
                right: 10px;
                font-size: 12px;
                padding: 8px 15px;
            }

            .live-clock {
                font-size: 18px;
                padding: 8px 12px;
            }

            .controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .timer {
                font-size: 60px;
                padding: 20px;
                letter-spacing: 5px;
            }
            
            .current-stop {
                font-size: 28px;
            }
            
            .line-info {
                font-size: 18px;
            }

            .live-clock {
                font-size: 16px;
                padding: 6px 10px;
            }

            .folder-header {
                grid-template-columns: auto 1fr auto;
            }

            .folder-count {
                display: none;
            }

            .route-tree-header {
                grid-template-columns: 1fr auto;
            }
        }
    </style>
	</head>
<body>
    <!-- ZEGAR NA ≈ªYWO -->
    <div class="live-clock" id="liveClock">
        <div id="clockTime">00:00:00</div>
        <div class="clock-date" id="clockDate">Pon, 1 Sty 2024</div>
    </div>

    <div class="container">
        <!-- EKRAN KONFIGURACJI -->
        <div class="setup-screen active">
            <h1>üöå System Przystank√≥w</h1>
            
            <!-- NOWY PRZYCISK DODAWANIA -->
            <button class="add-route-btn" id="toggleAddBtn" onclick="toggleAddForm()">
                ‚ûï DODAJ NOWƒÑ LINIƒò
            </button>

            <!-- FORMULARZ DODAWANIA - UKRYTY DOMY≈öLNIE -->
            <div class="card quick-add" id="quickAddForm">
                <h3>‚ö° Szybkie tworzenie linii</h3>
                <div class="input-group">
                    <input type="text" id="lineNumber" placeholder="Numer linii (np. 157)">
                    <input type="text" id="direction" placeholder="Kierunek (np. Dworzec)">
                </div>
                
                <h3 style="margin-top: 20px;">‚ûï Dodawanie przystank√≥w</h3>
                <div class="input-group">
                    <input type="text" id="stopName" placeholder="Nazwa przystanku">
                    <input type="number" id="stopMinutes" placeholder="Minut" min="0" value="1">
                    <button class="btn-primary btn-icon" onclick="addStop()">‚ûï</button>
                </div>
                
                <div class="stops-editor" id="stopsEditor">
                    <div class="empty-state">
                        <div class="empty-state-icon">üöè</div>
                        <p>Dodaj przystanki aby utworzyƒá trasƒô</p>
                    </div>
                </div>
                
                <button class="btn-primary" id="saveRouteBtn" onclick="saveRoute()" style="margin-top: 20px; width: 100%;">
                    üíæ Zapisz liniƒô do Firebase
                </button>
            </div>

            <!-- SYSTEM GRUPOWANIA -->
            <div class="card groups-container">
                <h2>üìÇ ZarzƒÖdzanie grupami i liniami</h2>
                
                <div class="group-controls">
                    <input type="text" id="newGroupName" placeholder="Nazwa nowej grupy (np. Autobusy, Tramwaje...)">
                    <button class="btn-primary" onclick="createGroup()">‚ûï Utw√≥rz grupƒô</button>
                </div>
				                <!-- WYSZUKIWARKI -->
                <div class="search-panel">
                    <div class="search-box">
                        <input type="text" id="searchLines" placeholder="üîç Szukaj linii (np. 157, tramwaj...)">
                        <button class="btn-secondary btn-icon" onclick="clearSearch('searchLines')">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchStops" placeholder="üöè Szukaj po przystanku lub kierunku...">
                        <button class="btn-secondary btn-icon" onclick="clearSearch('searchStops')">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="search-results" id="searchResults"></div>
                </div>

                <!-- DRZEWO GRUP I LINII -->
                <div class="tree-view" id="treeView">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>Brak grup i linii</p>
                        <p style="font-size: 14px; margin-top: 10px; color: #666;">Utw√≥rz grupy aby uporzƒÖdkowaƒá linie</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- EKRAN DZIA≈ÅANIA - NOWY LAYOUT -->
        <div class="running-screen">
            <div class="keyboard-hint">‚å®Ô∏è ENTER/SPACJA = Nastƒôpny | ‚Üê = Cofnij | ESC = Zako≈Ñcz</div>
            <div class="running-layout">
                <!-- LEWA KOLUMNA - G≈Å√ìWNY WY≈öWIETLACZ -->
                <div class="main-display-column">
                    <div class="bus-display">
                        <!-- ETA DO KO≈ÉCA TRASY -->
                        <div class="eta-badge" id="etaBadge">
                            <div class="eta-label">Koniec trasy o</div>
                            <div class="eta-time" id="etaTime">--:--</div>
                        </div>

                        <div class="line-info" id="lineInfo">LINIA 1 ‚Üí CENTRUM</div>
                        <div class="next-stop-label">üöè Nastƒôpny przystanek</div>
                        <div class="current-stop" id="currentStopName">DWORZEC G≈Å√ìWNY</div>
                        
                        <div class="timer-container">
                            <div class="timer" id="timer">0:00</div>
                            <div class="delay-indicator" id="delayIndicator">NA CZAS</div>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="btn-warning btn-icon" onclick="previousStop()" id="prevBtn" title="Cofnij (‚Üê)">
                            ‚óÄ
                        </button>
                        <button class="btn-primary" onclick="departStop()">
                            üöÄ ODJAZD
                        </button>
                        <button class="btn-primary btn-icon" onclick="departStop()" title="Nastƒôpny (ENTER/SPACJA)">
                            ‚ñ∂
                        </button>
                        <button class="btn-danger" onclick="endRoute()">
                            ‚èπÔ∏è KONIEC
                        </button>
                    </div>
                </div>

                <!-- PRAWA KOLUMNA - SIDEBAR -->
                <div class="sidebar-column">
                    <!-- STATUS -->
                    <div class="status-bar">
                        <div class="status-item">
                            <div class="status-label">Przystanek</div>
                            <div class="status-value" id="stopCounter">1/5</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Postƒôp trasy</div>
                            <div class="status-value" id="routeProgress">0%</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">≈örednie op√≥≈∫nienie</div>
                            <div class="status-value" id="avgDelay">0:00</div>
                        </div>
                    </div>

                    <div class="route-progress">
                        <div class="route-progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>

                    <!-- ROZK≈ÅAD JAZDY -->
                    <div class="schedule-container">
                        <div class="schedule-header">
                            <h2 style="margin: 0; font-size: 1.2em;">üìç Rozk≈Çad jazdy</h2>
                        </div>
                        <div class="schedule-list" id="scheduleList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL WYBORU CZASU -->
    <div class="modal" id="timeModal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 20px;">üïê Wybierz czas startu</h2>
            <div class="time-picker">
                <input type="number" id="hourInput" min="0" max="23" value="08" />
                <div class="time-separator">:</div>
                <input type="number" id="minuteInput" min="0" max="59" value="00" />
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-secondary" onclick="setCurrentTime()">‚è∞ Teraz</button>
                <button class="btn-primary" onclick="confirmStartTime()">‚úÖ Start</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRZENOSZENIA DO GRUPY -->
    <div class="modal" id="moveToGroupModal">
        <div class="modal-content">
            <h2 style="text-align: center; margin-bottom: 20px;">üìÅ Przenie≈õ do grupy</h2>
            <div id="groupSelectionList" style="max-height: 400px; overflow-y: auto;"></div>
            <button class="btn-danger" onclick="closeMoveModal()" style="margin-top: 20px; width: 100%;">‚ùå Anuluj</button>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDM2EOp4JioeWWPRrRbOiVHUKbCTnemgvA",
            authDomain: "b57-5b0cc.firebaseapp.com",
            databaseURL: "https://b57-5b0cc-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "b57-5b0cc",
            storageBucket: "b57-5b0cc.firebasestorage.app",
            messagingSenderId: "119379327363",
            appId: "1:119379327363:web:2006e0e0c53c6ab22b1eb6"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.database = database;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbPush = push;
        window.dbRemove = remove;

        loadGroups();
    </script>

    <script>
        let stops = [];
        let currentRoute = null;
        let currentStopIndex = 0;
        let plannedTimes = [];
        let timerInterval = null;
        let clockInterval = null;
        let delayHistory = [];
        let selectedRouteId = null;
        let editingRouteId = null;
        let groups = {}; // { groupId: { name, children: [groupId/routeId], parent: groupId } }
        let routes = {}; // { routeId: { lineNumber, direction, stops, parentGroup } }
        let moveRouteId = null; // ID linii do przeniesienia

        // ========================================
        // NOWA FUNKCJA: TOGGLE FORMULARZA
        // ========================================
        function toggleAddForm() {
            const form = document.getElementById('quickAddForm');
            const btn = document.getElementById('toggleAddBtn');
            
            if (form.classList.contains('active')) {
                form.classList.remove('active');
                btn.classList.remove('active');
                btn.textContent = '‚ûï DODAJ NOWƒÑ LINIƒò';
            } else {
                form.classList.add('active');
                btn.classList.add('active');
                btn.textContent = '‚ùå ANULUJ DODAWANIE';
                
                // Scroll do formularza
                setTimeout(() => {
                    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // ========================================
        // SYSTEM GRUPOWANIA
        // ========================================

        async function createGroup(parentId = null) {
            const name = document.getElementById('newGroupName').value.trim();
            if (!name) {
                alert('‚ùå Podaj nazwƒô grupy!');
                return;
            }

            try {
                const groupRef = window.dbPush(window.dbRef(window.database, 'groups'));
                await window.dbSet(groupRef, {
                    name,
                    parent: parentId,
                    children: [],
                    created: new Date().toISOString()
                });

                if (parentId) {
                    // Dodaj do rodzica
                    const parentSnapshot = await window.dbGet(window.dbRef(window.database, `groups/${parentId}`));
                    if (parentSnapshot.exists()) {
                        const parent = parentSnapshot.val();
                        parent.children = parent.children || [];
                        parent.children.push(groupRef.key);
                        await window.dbSet(window.dbRef(window.database, `groups/${parentId}`), parent);
                    }
                }

                document.getElementById('newGroupName').value = '';
                alert('‚úÖ Grupa utworzona!');
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd tworzenia grupy:', error);
                alert('‚ùå B≈ÇƒÖd podczas tworzenia grupy!');
            }
        }

        async function loadGroups() {
            try {
                const [groupsSnapshot, routesSnapshot] = await Promise.all([
                    window.dbGet(window.dbRef(window.database, 'groups')),
                    window.dbGet(window.dbRef(window.database, 'routes'))
                ]);

                groups = groupsSnapshot.exists() ? groupsSnapshot.val() : {};
                routes = routesSnapshot.exists() ? routesSnapshot.val() : {};

                renderTree();
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania danych:', error);
            }
        }
		        // ========================================
        // WYSZUKIWARKI
        // ========================================

        let searchTimeout = null;

        // Event listenery dla wyszukiwarek
        document.addEventListener('DOMContentLoaded', function() {
            const searchLines = document.getElementById('searchLines');
            const searchStops = document.getElementById('searchStops');
            
            if (searchLines) {
                searchLines.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => performSearch(), 300);
                });
            }
            
            if (searchStops) {
                searchStops.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => performSearch(), 300);
                });
            }
        });

        function performSearch() {
            const lineQuery = document.getElementById('searchLines').value.trim().toLowerCase();
            const stopQuery = document.getElementById('searchStops').value.trim().toLowerCase();
            
            if (!lineQuery && !stopQuery) {
                document.getElementById('searchResults').classList.remove('active');
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            const results = [];

            Object.entries(routes).forEach(([id, route]) => {
                let score = 0;
                let matchedStops = [];
                let matchType = '';

                // Wyszukiwanie po nazwie linii
                if (lineQuery) {
                    const lineNumber = route.lineNumber.toLowerCase();
                    const direction = route.direction.toLowerCase();
                    
                    if (lineNumber.includes(lineQuery)) {
                        score += 10;
                        matchType = 'linia';
                    }
                    if (direction.includes(lineQuery)) {
                        score += 5;
                        matchType = matchType ? 'linia+kierunek' : 'kierunek';
                    }
                }

                // Wyszukiwanie po przystankach/kierunku
                if (stopQuery) {
                    const direction = route.direction.toLowerCase();
                    
                    if (direction.includes(stopQuery)) {
                        score += 8;
                        matchType = matchType ? matchType + '+kierunek' : 'kierunek';
                    }

                    route.stops.forEach((stop, index) => {
                        if (stop.name.toLowerCase().includes(stopQuery)) {
                            score += 3;
                            matchedStops.push(index);
                            matchType = matchType ? matchType + '+przystanek' : 'przystanek';
                        }
                    });
                }

                if (score > 0) {
                    results.push({
                        id,
                        route,
                        score,
                        matchedStops,
                        matchType
                    });
                }
            });

            // Sortuj po score
            results.sort((a, b) => b.score - a.score);

            displaySearchResults(results, stopQuery);
        }

        function displaySearchResults(results, highlightQuery) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <p>Brak wynik√≥w</p>
                    </div>
                `;
                container.classList.add('active');
                return;
            }

            container.innerHTML = '';
            container.classList.add('active');

            results.forEach(result => {
                const { id, route, matchedStops, matchType } = result;
                const totalTime = route.stops.reduce((sum, s) => sum + s.minutes, 0);
                
                // Znajd≈∫ ≈õcie≈ºkƒô grupy
                const groupPath = getGroupPath(route.parentGroup);
                
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.onclick = () => {
                    highlightRouteInTree(id);
                };

                let stopsHtml = '';
                if (matchedStops.length > 0 || highlightQuery) {
                    stopsHtml = '<div class="search-result-stops">';
                    route.stops.forEach((stop, index) => {
                        const isMatched = matchedStops.includes(index);
                        const chipClass = isMatched ? 'search-stop-chip highlight' : 'search-stop-chip';
                        stopsHtml += `<div class="${chipClass}">${stop.name}</div>`;
                    });
                    stopsHtml += '</div>';
                }

                div.innerHTML = `
                    <div class="search-result-header">
                        <div class="search-result-title">üöå Linia ${route.lineNumber}</div>
                        <div class="search-result-badge">${matchType}</div>
                    </div>
                    <div class="search-result-details">
                        üìç ${route.direction} ‚Ä¢ ${route.stops.length} przystank√≥w ‚Ä¢ ${totalTime} min
                    </div>
                    ${groupPath ? `<div class="search-result-path">üìÅ ${groupPath}</div>` : ''}
                    ${stopsHtml}
                `;

                container.appendChild(div);
            });
        }

        function getGroupPath(groupId) {
            if (!groupId || !groups[groupId]) return '';
            
            const path = [];
            let currentId = groupId;
            
            while (currentId && groups[currentId]) {
                path.unshift(groups[currentId].name);
                currentId = groups[currentId].parent;
            }
            
            return path.join(' > ');
        }

        function highlightRouteInTree(routeId) {
            const route = routes[routeId];
            if (!route) return;

            // Rozwi≈Ñ wszystkie grupy w ≈õcie≈ºce
            let currentGroupId = route.parentGroup;
            while (currentGroupId && groups[currentGroupId]) {
                const toggle = document.getElementById(`toggle-${currentGroupId}`);
                const content = document.getElementById(`content-${currentGroupId}`);
                
                if (toggle && content) {
                    content.classList.add('expanded');
                    toggle.classList.add('expanded');
                }
                
                currentGroupId = groups[currentGroupId].parent;
            }

            // Przewi≈Ñ do elementu
            setTimeout(() => {
                const treeView = document.getElementById('treeView');
                const routeElements = treeView.querySelectorAll('.tree-route');
                
                routeElements.forEach(el => {
                    if (el.innerHTML.includes(route.lineNumber) && el.innerHTML.includes(route.direction)) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Efekt pod≈õwietlenia
                        el.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.8)';
                        el.style.transform = 'scale(1.02)';
                        
                        setTimeout(() => {
                            el.style.boxShadow = '';
                            el.style.transform = '';
                        }, 2000);
                    }
                });
            }, 300);
        }

        function clearSearch(inputId) {
            document.getElementById(inputId).value = '';
            performSearch();
        }

        function renderTree() {
            const treeView = document.getElementById('treeView');
            
            // Znajd≈∫ grupy g≈Ç√≥wne (bez rodzica)
            const rootGroups = Object.entries(groups).filter(([id, group]) => !group.parent);
            
            // Znajd≈∫ linie bez grupy
            const orphanRoutes = Object.entries(routes).filter(([id, route]) => !route.parentGroup);

            if (rootGroups.length === 0 && orphanRoutes.length === 0) {
                treeView.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>Brak grup i linii</p>
                        <p style="font-size: 14px; margin-top: 10px; color: #666;">Utw√≥rz grupy aby uporzƒÖdkowaƒá linie</p>
                    </div>
                `;
                return;
            }

            treeView.innerHTML = '';

            // Renderuj grupy g≈Ç√≥wne
            rootGroups.forEach(([id, group]) => {
                treeView.appendChild(renderGroup(id, group, 1));
            });

            // Renderuj linie bez grupy
            if (orphanRoutes.length > 0) {
                const orphanSection = document.createElement('div');
                orphanSection.style.marginTop = '15px';
                orphanSection.innerHTML = '<h3 style="color: #888; font-size: 14px; margin-bottom: 10px;">üìå Linie bez grupy</h3>';
                
                orphanRoutes.forEach(([id, route]) => {
                    orphanSection.appendChild(renderRoute(id, route));
                });
                
                treeView.appendChild(orphanSection);
            }
        }

        function renderGroup(groupId, group, level = 1) {
            const div = document.createElement('div');
            div.className = `tree-folder level-${Math.min(level, 3)}`;
            
            const children = group.children || [];
            const childCount = children.length;
            
            // Ikona zale≈ºna od poziomu
            const icons = ['üìÅ', 'üìÇ', 'üóÇÔ∏è'];
            const icon = icons[Math.min(level - 1, 2)];

            div.innerHTML = `
                <div class="folder-header" onclick="toggleFolder('${groupId}')">
                    <div class="folder-toggle" id="toggle-${groupId}">‚ñ∂</div>
                    <div class="folder-icon">${icon}</div>
                    <div class="folder-name">${group.name}</div>
                    <div class="folder-count">${childCount}</div>
                    <div class="folder-actions" onclick="event.stopPropagation()">
                        <button class="btn-primary" onclick="createSubgroup('${groupId}')" title="Dodaj podgrupƒô">‚ûï</button>
                        <button class="btn-warning" onclick="renameGroup('${groupId}')" title="Zmie≈Ñ nazwƒô">‚úèÔ∏è</button>
                        <button class="btn-danger" onclick="deleteGroup('${groupId}')" title="Usu≈Ñ grupƒô">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="folder-content" id="content-${groupId}">
                    <div class="folder-children" id="children-${groupId}"></div>
                </div>
            `;

            // Renderuj dzieci po dodaniu do DOM
            setTimeout(() => {
                const childrenContainer = document.getElementById(`children-${groupId}`);
                if (childrenContainer && children.length > 0) {
                    children.forEach(childId => {
                        if (groups[childId]) {
                            // To jest podgrupa
                            childrenContainer.appendChild(renderGroup(childId, groups[childId], level + 1));
                        } else if (routes[childId]) {
                            // To jest linia
                            childrenContainer.appendChild(renderRoute(childId, routes[childId]));
                        }
                    });
                }
            }, 0);

            return div;
        }

        function renderRoute(routeId, route) {
            const div = document.createElement('div');
            div.className = 'tree-route';
            
            const totalTime = route.stops.reduce((sum, s) => sum + s.minutes, 0);
            
            div.innerHTML = `
                <div class="route-tree-header">
                    <div class="folder-icon">üöå</div>
                    <div class="route-tree-info">
                        <div class="route-tree-title">Linia ${route.lineNumber} ‚Üí ${route.direction}</div>
                        <div class="route-tree-details">${route.stops.length} przystank√≥w ‚Ä¢ ${totalTime} min</div>
                    </div>
                    <div class="route-tree-actions">
                        <button class="btn-primary" onclick="startRoute('${routeId}')" title="Uruchom">‚ñ∂Ô∏è</button>
                        <button class="btn-secondary" onclick="openMoveModal('${routeId}')" title="Przenie≈õ">üìÅ</button>
                        <button class="btn-warning" onclick="editRoute('${routeId}')" title="Edytuj">‚úèÔ∏è</button>
                        <button class="btn-danger" onclick="deleteRoute('${routeId}')" title="Usu≈Ñ">üóëÔ∏è</button>
                    </div>
                </div>
            `;

            return div;
        }

        function toggleFolder(groupId) {
            const toggle = document.getElementById(`toggle-${groupId}`);
            const content = document.getElementById(`content-${groupId}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        async function createSubgroup(parentId) {
            const name = prompt('Nazwa podgrupy:');
            if (!name || !name.trim()) return;

            try {
                const groupRef = window.dbPush(window.dbRef(window.database, 'groups'));
                await window.dbSet(groupRef, {
                    name: name.trim(),
                    parent: parentId,
                    children: [],
                    created: new Date().toISOString()
                });

                // Dodaj do rodzica
                const parentSnapshot = await window.dbGet(window.dbRef(window.database, `groups/${parentId}`));
                if (parentSnapshot.exists()) {
                    const parent = parentSnapshot.val();
                    parent.children = parent.children || [];
                    parent.children.push(groupRef.key);
                    await window.dbSet(window.dbRef(window.database, `groups/${parentId}`), parent);
                }

                alert('‚úÖ Podgrupa utworzona!');
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('‚ùå B≈ÇƒÖd podczas tworzenia podgrupy!');
            }
        }

        async function renameGroup(groupId) {
            const group = groups[groupId];
            if (!group) return;

            const newName = prompt('Nowa nazwa grupy:', group.name);
            if (!newName || !newName.trim()) return;

            try {
                await window.dbSet(window.dbRef(window.database, `groups/${groupId}/name`), newName.trim());
                alert('‚úÖ Nazwa zmieniona!');
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('‚ùå B≈ÇƒÖd podczas zmiany nazwy!');
            }
        }

        async function deleteGroup(groupId) {
            const group = groups[groupId];
            if (!group) return;

            const children = group.children || [];
            if (children.length > 0) {
                if (!confirm(`‚ö†Ô∏è Ta grupa zawiera ${children.length} element√≥w. Usu≈Ñ jƒÖ wraz z zawarto≈õciƒÖ?`)) {
                    return;
                }
            } else {
                if (!confirm(`üóëÔ∏è UsunƒÖƒá grupƒô "${group.name}"?`)) {
                    return;
                }
            }

            try {
                // Usu≈Ñ rekurencyjnie dzieci
                for (const childId of children) {
                    if (groups[childId]) {
                        await deleteGroup(childId);
                    } else if (routes[childId]) {
                        await window.dbRemove(window.dbRef(window.database, `routes/${childId}`));
                    }
                }

                // Usu≈Ñ z rodzica
                if (group.parent) {
                    const parentSnapshot = await window.dbGet(window.dbRef(window.database, `groups/${group.parent}`));
                    if (parentSnapshot.exists()) {
                        const parent = parentSnapshot.val();
                        parent.children = (parent.children || []).filter(id => id !== groupId);
                        await window.dbSet(window.dbRef(window.database, `groups/${group.parent}`), parent);
                    }
                }

                // Usu≈Ñ grupƒô
                await window.dbRemove(window.dbRef(window.database, `groups/${groupId}`));
                
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('‚ùå B≈ÇƒÖd podczas usuwania grupy!');
            }
        }

        // ========================================
        // PRZENOSZENIE LINII MIƒòDZY GRUPAMI
        // ========================================

        function openMoveModal(routeId) {
            moveRouteId = routeId;
            const modal = document.getElementById('moveToGroupModal');
            const listDiv = document.getElementById('groupSelectionList');
            
            listDiv.innerHTML = '';

            // Opcja: bez grupy
            const noGroupBtn = document.createElement('button');
            noGroupBtn.className = 'btn-secondary';
            noGroupBtn.style.width = '100%';
            noGroupBtn.style.marginBottom = '10px';
            noGroupBtn.textContent = 'üìå Przenie≈õ poza grupy';
            noGroupBtn.onclick = () => moveRouteToGroup(null);
            listDiv.appendChild(noGroupBtn);

            // Wszystkie grupy
            Object.entries(groups).forEach(([id, group]) => {
                const btn = document.createElement('button');
                btn.className = 'btn-primary';
                btn.style.width = '100%';
                btn.style.marginBottom = '10px';
                btn.textContent = `üìÅ ${group.name}`;
                btn.onclick = () => moveRouteToGroup(id);
                listDiv.appendChild(btn);
            });

            modal.classList.add('active');
        }

        function closeMoveModal() {
            document.getElementById('moveToGroupModal').classList.remove('active');
            moveRouteId = null;
        }

        async function moveRouteToGroup(groupId) {
            if (!moveRouteId) return;

            try {
                const route = routes[moveRouteId];
                const oldParent = route.parentGroup;

                // Usu≈Ñ ze starej grupy
                if (oldParent) {
                    const oldParentSnapshot = await window.dbGet(window.dbRef(window.database, `groups/${oldParent}`));
                    if (oldParentSnapshot.exists()) {
                        const parent = oldParentSnapshot.val();
                        parent.children = (parent.children || []).filter(id => id !== moveRouteId);
                        await window.dbSet(window.dbRef(window.database, `groups/${oldParent}`), parent);
                    }
                }

                // Dodaj do nowej grupy
                if (groupId) {
                    const newParentSnapshot = await window.dbGet(window.dbRef(window.database, `groups/${groupId}`));
                    if (newParentSnapshot.exists()) {
                        const parent = newParentSnapshot.val();
                        parent.children = parent.children || [];
                        parent.children.push(moveRouteId);
                        await window.dbSet(window.dbRef(window.database, `groups/${groupId}`), parent);
                    }
                }

                // Zaktualizuj liniƒô
                await window.dbSet(window.dbRef(window.database, `routes/${moveRouteId}/parentGroup`), groupId);

                closeMoveModal();
                alert('‚úÖ Linia przeniesiona!');
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('‚ùå B≈ÇƒÖd podczas przenoszenia!');
            }
        }

        // ========================================
        // RESZTA KODU (ZEGAR, DODAWANIE, EDYCJA)
        // ========================================

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('clockTime').textContent = `${hours}:${minutes}:${seconds}`;
            
            const days = ['Nie', 'Pon', 'Wto', '≈öro', 'Czw', 'PiƒÖ', 'Sob'];
            const months = ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'Pa≈∫', 'Lis', 'Gru'];
            const dayName = days[now.getDay()];
            const day = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            document.getElementById('clockDate').textContent = `${dayName}, ${day} ${month} ${year}`;
        }

        updateClock();
        clockInterval = setInterval(updateClock, 1000);

        function playDepartSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                if (document.querySelector('.running-screen').classList.contains('active')) {
                    event.preventDefault();
                    departStop();
                }
                else if (event.target.id === 'stopName' || event.target.id === 'stopMinutes') {
                    event.preventDefault();
                    addStop();
                }
            }
            
            if (event.code === 'Space') {
                if (document.querySelector('.running-screen').classList.contains('active')) {
                    event.preventDefault();
                    departStop();
                }
                else if (event.target.id === 'stopMinutes') {
                    event.preventDefault();
                    addStop();
                }
            }
            
            if (event.key === 'ArrowLeft' && document.querySelector('.running-screen').classList.contains('active')) {
                event.preventDefault();
                previousStop();
            }
            
            if (event.key === 'ArrowRight' && document.querySelector('.running-screen').classList.contains('active')) {
                event.preventDefault();
                departStop();
            }
            
            if (event.key === 'Escape' && document.querySelector('.running-screen').classList.contains('active')) {
                event.preventDefault();
                if (confirm('Czy na pewno zako≈Ñczyƒá trasƒô?')) {
                    endRoute();
                }
            }
        });

        function addStop() {
            const name = document.getElementById('stopName').value.trim();
            const minutes = parseInt(document.getElementById('stopMinutes').value) || 0;

            if (!name) {
                alert('‚ùå Podaj nazwƒô przystanku!');
                return;
            }

            stops.push({ name, minutes });
            document.getElementById('stopName').value = '';
            document.getElementById('stopMinutes').value = '1';
            document.getElementById('stopName').focus();
            
            renderStopList();
        }

        function renderStopList() {
            const editor = document.getElementById('stopsEditor');
            
            if (stops.length === 0) {
                editor.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üöè</div>
                        <p>Dodaj przystanki aby utworzyƒá trasƒô</p>
                    </div>
                `;
                return;
            }

            editor.innerHTML = '';
            
            stops.forEach((stop, index) => {
                const div = document.createElement('div');
                div.className = 'stop-item';
                div.draggable = true;
                div.dataset.index = index;
                
                let timeInfo = index === 0 ? 'START' : `+${stop.minutes} min`;
                let totalTime = stops.slice(0, index + 1).reduce((sum, s) => sum + s.minutes, 0);
                
                div.innerHTML = `
                    <div class="stop-number">${index + 1}</div>
                    <div class="stop-info">
                        <div class="stop-name">${stop.name}</div>
                        <div class="stop-time">Suma: ${totalTime} min od startu</div>
                    </div>
                    <div class="stop-duration">${timeInfo}</div>
                    <button class="btn-secondary btn-icon" onclick="editStop(${index})">‚úèÔ∏è</button>
                    <button class="btn-danger btn-icon" onclick="removeStop(${index})">üóëÔ∏è</button>
                `;
                
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);
                
                editor.appendChild(div);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const fromIndex = parseInt(draggedElement.dataset.index);
                const toIndex = parseInt(this.dataset.index);
                
                const item = stops.splice(fromIndex, 1)[0];
                stops.splice(toIndex, 0, item);
                
                renderStopList();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        function editStop(index) {
            const stop = stops[index];
            const newName = prompt('Nowa nazwa przystanku:', stop.name);
            if (newName && newName.trim()) {
                stop.name = newName.trim();
            }
            
            if (index > 0) {
                const newMinutes = prompt('Minut od poprzedniego:', stop.minutes);
                if (newMinutes !== null) {
                    stop.minutes = parseInt(newMinutes) || 0;
                }
            }
            
            renderStopList();
        }

        function removeStop(index) {
            stops.splice(index, 1);
            renderStopList();
        }

        async function saveRoute() {
            const lineNumber = document.getElementById('lineNumber').value.trim();
            const direction = document.getElementById('direction').value.trim();

            if (!lineNumber || !direction) {
                alert('‚ùå Podaj numer linii i kierunek!');
                return;
            }

            if (stops.length < 2) {
                alert('‚ùå Dodaj co najmniej 2 przystanki!');
                return;
            }

            const route = {
                lineNumber,
                direction,
                stops: [...stops],
                parentGroup: null,
                created: new Date().toISOString()
            };

            try {
                const routesRef = window.dbPush(window.dbRef(window.database, 'routes'));
                await window.dbSet(routesRef, route);
                
                alert('‚úÖ Linia zapisana pomy≈õlnie!');
                stops = [];
                document.getElementById('lineNumber').value = '';
                document.getElementById('direction').value = '';
                renderStopList();
                
                // Ukryj formularz
                toggleAddForm();
                
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd zapisu:', error);
                alert('‚ùå B≈ÇƒÖd podczas zapisu!');
            }
        }

        async function editRoute(id) {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.database, `routes/${id}`));
                if (!snapshot.exists()) return;

                const route = snapshot.val();
                
                stops = [...route.stops];
                document.getElementById('lineNumber').value = route.lineNumber;
                document.getElementById('direction').value = route.direction;
                renderStopList();
                
                editingRouteId = id;
                
                // Poka≈º formularz
                if (!document.getElementById('quickAddForm').classList.contains('active')) {
                    toggleAddForm();
                }
                
                const saveBtn = document.getElementById('saveRouteBtn');
                saveBtn.textContent = 'üíæ Zapisz zmiany';
                saveBtn.onclick = () => updateRoute(id);
                
                alert('‚úèÔ∏è Trasa za≈Çadowana do edycji. Po zako≈Ñczeniu kliknij "Zapisz zmiany".');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('B≈ÇƒÖd edycji:', error);
                alert('‚ùå B≈ÇƒÖd podczas ≈Çadowania trasy!');
            }
        }

        async function updateRoute(id) {
            const lineNumber = document.getElementById('lineNumber').value.trim();
            const direction = document.getElementById('direction').value.trim();

            if (!lineNumber || !direction) {
                alert('‚ùå Podaj numer linii i kierunek!');
                return;
            }

            if (stops.length < 2) {
                alert('‚ùå Dodaj co najmniej 2 przystanki!');
                return;
            }

            try {
                const snapshot = await window.dbGet(window.dbRef(window.database, `routes/${id}`));
                const existingRoute = snapshot.val();

                const route = {
                    lineNumber,
                    direction,
                    stops: [...stops],
                    parentGroup: existingRoute.parentGroup || null,
                    created: existingRoute.created || new Date().toISOString()
                };

                await window.dbSet(window.dbRef(window.database, `routes/${id}`), route);
                
                alert('‚úÖ Linia zaktualizowana pomy≈õlnie!');
                
                stops = [];
                document.getElementById('lineNumber').value = '';
                document.getElementById('direction').value = '';
                renderStopList();
                editingRouteId = null;
                
                const saveBtn = document.getElementById('saveRouteBtn');
                saveBtn.textContent = 'üíæ Zapisz liniƒô do Firebase';
                saveBtn.onclick = saveRoute;
                
                // Ukryj formularz
                toggleAddForm();
                
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd zapisu:', error);
                alert('‚ùå B≈ÇƒÖd podczas zapisu!');
            }
        }

        async function deleteRoute(id) {
            if (!confirm('üóëÔ∏è Czy na pewno usunƒÖƒá tƒô liniƒô?')) return;
            
            try {
                const snapshot = await window.dbGet(window.dbRef(window.database, `routes/${id}`));
                if (!snapshot.exists()) return;

                const route = snapshot.val();

                // Usu≈Ñ z grupy rodzica
                if (route.parentGroup) {
                    const parentSnapshot = await window.dbGet(window.dbRef(window.database, `groups/${route.parentGroup}`));
                    if (parentSnapshot.exists()) {
                        const parent = parentSnapshot.val();
                        parent.children = (parent.children || []).filter(childId => childId !== id);
                        await window.dbSet(window.dbRef(window.database, `groups/${route.parentGroup}`), parent);
                    }
                }

                await window.dbRemove(window.dbRef(window.database, `routes/${id}`));
                loadGroups();
            } catch (error) {
                console.error('B≈ÇƒÖd usuwania:', error);
            }
        }

        async function startRoute(routeId) {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.database, `routes/${routeId}`));
                if (!snapshot.exists()) return;

                selectedRouteId = routeId;
                currentRoute = snapshot.val();
                
                const now = new Date();
                document.getElementById('hourInput').value = String(now.getHours()).padStart(2, '0');
                document.getElementById('minuteInput').value = String(now.getMinutes()).padStart(2, '0');
                document.getElementById('timeModal').classList.add('active');
                
            } catch (error) {
                console.error('B≈ÇƒÖd startu trasy:', error);
            }
        }

        function setCurrentTime() {
            const now = new Date();
            document.getElementById('hourInput').value = String(now.getHours()).padStart(2, '0');
            document.getElementById('minuteInput').value = String(now.getMinutes()).padStart(2, '0');
        }

        function confirmStartTime() {
            const hours = parseInt(document.getElementById('hourInput').value) || 0;
            const minutes = parseInt(document.getElementById('minuteInput').value) || 0;

            if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                alert('‚ùå Nieprawid≈Çowy czas!');
                return;
            }

            const startDate = new Date();
            startDate.setHours(hours, minutes, 0, 0);
            
            plannedTimes = [];
            let cumulativeMinutes = 0;
            
            currentRoute.stops.forEach(stop => {
                const plannedTime = new Date(startDate.getTime() + cumulativeMinutes * 60000);
                plannedTimes.push(plannedTime);
                cumulativeMinutes += stop.minutes;
            });

            currentStopIndex = 0;
            delayHistory = [];

            document.getElementById('timeModal').classList.remove('active');
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.running-screen').classList.add('active');

            updateDisplay();
            startTimer();
        }

        function getCurrentDelay() {
            const now = new Date();
            const targetTime = plannedTimes[currentStopIndex];
            return Math.floor((now - targetTime) / 1000);
        }

        function getEstimatedArrivalTime(stopIndex) {
            if (stopIndex < currentStopIndex) {
                return null;
            }
            
            let minutesFromNow = 0;
            for (let i = currentStopIndex; i <= stopIndex; i++) {
                minutesFromNow += currentRoute.stops[i].minutes;
            }
            
            const now = new Date();
            const estimatedTime = new Date(now.getTime() + minutesFromNow * 60000);
            const plannedTime = plannedTimes[stopIndex];
            
            const diffSeconds = Math.abs(estimatedTime - plannedTime) / 1000;
            if (diffSeconds < 30) {
                return null;
            }
            
            return estimatedTime;
        }

        function updateDisplay() {
            document.getElementById('lineInfo').textContent = 
                `LINIA ${currentRoute.lineNumber} ‚Üí ${currentRoute.direction.toUpperCase()}`;
            
            document.getElementById('currentStopName').textContent = 
                currentRoute.stops[currentStopIndex].name.toUpperCase();

            const total = currentRoute.stops.length;
            const progress = Math.round((currentStopIndex / (total - 1)) * 100);
            
            document.getElementById('stopCounter').textContent = `${currentStopIndex + 1}/${total}`;
            document.getElementById('routeProgress').textContent = `${progress}%`;
            document.getElementById('progressBar').style.width = `${progress}%`;

            if (delayHistory.length > 0) {
                const avgDelay = Math.round(delayHistory.reduce((a, b) => a + b, 0) / delayHistory.length);
                const avgMin = Math.floor(Math.abs(avgDelay) / 60);
                const avgSec = Math.abs(avgDelay) % 60;
                const sign = avgDelay >= 0 ? '-' : '+';
                document.getElementById('avgDelay').textContent = 
                    `${sign}${avgMin}:${String(avgSec).padStart(2, '0')}`;
            } else {
                document.getElementById('avgDelay').textContent = '0:00';
            }

            document.getElementById('prevBtn').disabled = (currentStopIndex === 0);

            updateETA();
            renderSchedule();
            scrollToCurrentStop();
        }

        function updateETA() {
            const lastStopIndex = plannedTimes.length - 1;
            const estimatedTime = getEstimatedArrivalTime(lastStopIndex);
            
            if (estimatedTime) {
                const hours = String(estimatedTime.getHours()).padStart(2, '0');
                const minutes = String(estimatedTime.getMinutes()).padStart(2, '0');
                document.getElementById('etaTime').textContent = `${hours}:${minutes}`;
            } else {
                const plannedTime = plannedTimes[lastStopIndex];
                const hours = String(plannedTime.getHours()).padStart(2, '0');
                const minutes = String(plannedTime.getMinutes()).padStart(2, '0');
                document.getElementById('etaTime').textContent = `${hours}:${minutes}`;
            }
        }

        function scrollToCurrentStop() {
            setTimeout(() => {
                const scheduleList = document.getElementById('scheduleList');
                const currentItem = scheduleList.querySelector('.schedule-item.current');
                
                if (currentItem && scheduleList) {
                    currentItem.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }, 200);
        }

        function renderSchedule() {
            const scheduleDiv = document.getElementById('scheduleList');
            scheduleDiv.innerHTML = '';

            currentRoute.stops.forEach((stop, index) => {
                const div = document.createElement('div');
                div.className = 'schedule-item';
                
                if (index < currentStopIndex) {
                    div.classList.add('passed');
                } else if (index === currentStopIndex) {
                    div.classList.add('current');
                } else if (index === currentStopIndex + 1) {
                    div.classList.add('next');
                }

                const time = plannedTimes[index];
                const timeStr = `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
                
                let estimatedTimeStr = '';
                if (index > currentStopIndex) {
                    const estimatedTime = getEstimatedArrivalTime(index);
                    
                    if (estimatedTime) {
                        const estHours = String(estimatedTime.getHours()).padStart(2, '0');
                        const estMinutes = String(estimatedTime.getMinutes()).padStart(2, '0');
                        estimatedTimeStr = `<div class="estimated-time">~${estHours}:${estMinutes}</div>`;
                    }
                }

                let delayBadge = '';
                if (index < currentStopIndex && delayHistory[index] !== undefined) {
                    const delay = delayHistory[index];
                    const delayMin = Math.floor(Math.abs(delay) / 60);
                    const delaySec = Math.abs(delay) % 60;
                    const sign = delay >= 0 ? '-' : '+';
                    const delayClass = delay <= -60 ? 'early' : delay < 60 ? 'on-time' : delay < 210 ? 'late' : 'very-late';
                    delayBadge = `<div class="delay-badge ${delayClass}">${sign}${delayMin}:${String(delaySec).padStart(2, '0')}</div>`;
                }

                div.innerHTML = `
                    <div class="schedule-stop-number">${index + 1}</div>
                    <div class="schedule-stop-info">
                        <div class="schedule-stop-name">${stop.name}</div>
                        <div class="schedule-stop-time">${index > 0 ? `+${stop.minutes} min` : 'START'}</div>
                    </div>
                    <div class="schedule-time-info">
                        <div class="schedule-time">${timeStr}</div>
                        ${estimatedTimeStr}
                    </div>
                    ${delayBadge}
                `;
                scheduleDiv.appendChild(div);
            });
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                const now = new Date();
                const targetTime = plannedTimes[currentStopIndex];
                const diff = Math.floor((now - targetTime) / 1000);

                const minutes = Math.floor(Math.abs(diff) / 60);
                const seconds = Math.abs(diff) % 60;
                
                const sign = diff >= 0 ? '-' : '';
                const timeStr = `${sign}${minutes}:${String(seconds).padStart(2, '0')}`;
                
                const timerEl = document.getElementById('timer');
                const indicatorEl = document.getElementById('delayIndicator');
                timerEl.textContent = timeStr;

                if (diff < 60) {
                    timerEl.style.backgroundColor = '#4CAF50';
                    timerEl.style.color = '#fff';
                    if (diff < 0) {
                        indicatorEl.textContent = '‚úÖ PRZED CZASEM';
                    } else {
                        indicatorEl.textContent = '‚úÖ NA CZAS';
                    }
                    indicatorEl.style.color = '#4CAF50';
                } else if (diff >= 60 && diff < 120) {
                    timerEl.style.backgroundColor = '#FFEB3B';
                    timerEl.style.color = '#333';
                    indicatorEl.textContent = '‚ö†Ô∏è MA≈ÅE OP√ì≈πNIENIE';
                    indicatorEl.style.color = '#F9A825';
                } else if (diff >= 120 && diff < 300) {
                    timerEl.style.backgroundColor = '#FF9800';
                    timerEl.style.color = '#fff';
                    indicatorEl.textContent = '‚ö†Ô∏è OP√ì≈πNIENIE';
                    indicatorEl.style.color = '#FF9800';
                } else {
                    timerEl.style.backgroundColor = '#F44336';
                    timerEl.style.color = '#fff';
                    indicatorEl.textContent = 'üö® DU≈ªE OP√ì≈πNIENIE';
                    indicatorEl.style.color = '#F44336';
                }

                updateETA();
                
                if (seconds % 5 === 0) {
                    updateEstimatedTimesOnly();
                }
            }, 100);
        }

        function updateEstimatedTimesOnly() {
            const scheduleItems = document.querySelectorAll('.schedule-item');
            
            scheduleItems.forEach((item, index) => {
                if (index > currentStopIndex) {
                    const timeInfo = item.querySelector('.schedule-time-info');
                    if (!timeInfo) return;
                    
                    const estimatedTime = getEstimatedArrivalTime(index);
                    let estEl = timeInfo.querySelector('.estimated-time');
                    
                    if (estimatedTime) {
                        const estHours = String(estimatedTime.getHours()).padStart(2, '0');
                        const estMinutes = String(estimatedTime.getMinutes()).padStart(2, '0');
                        const newText = `~${estHours}:${estMinutes}`;
                        
                        if (estEl) {
                            if (estEl.textContent !== newText) {
                                estEl.textContent = newText;
                            }
                        } else {
                            estEl = document.createElement('div');
                            estEl.className = 'estimated-time';
                            estEl.textContent = newText;
                            timeInfo.appendChild(estEl);
                        }
                    } else {
                        if (estEl) {
                            estEl.remove();
                        }
                    }
                }
            });
        }

        function previousStop() {
            if (currentStopIndex === 0) {
                return;
            }

            vibrate();
            
            currentStopIndex--;
            
            if (delayHistory.length > currentStopIndex) {
                delayHistory.pop();
            }

            updateDisplay();
        }

        function departStop() {
            if (!currentRoute) return;

            if (currentStopIndex >= currentRoute.stops.length - 1) {
                playDepartSound();
                vibrate();
                alert('üèÅ To by≈Ç ostatni przystanek!');
                endRoute();
                return;
            }

            const now = new Date();
            const plannedDeparture = plannedTimes[currentStopIndex];
            const delay = Math.floor((now - plannedDeparture) / 1000);
            delayHistory[currentStopIndex] = delay;

            playDepartSound();
            vibrate();

            currentStopIndex++;
            updateDisplay();
        }

        function endRoute() {
            if (timerInterval) clearInterval(timerInterval);
            
            if (delayHistory.length > 0) {
                const avgDelay = Math.round(delayHistory.reduce((a, b) => a + b, 0) / delayHistory.length);
                const avgMin = Math.floor(Math.abs(avgDelay) / 60);
                const avgSec = Math.abs(avgDelay) % 60;
                const sign = avgDelay >= 0 ? 'op√≥≈∫nienia' : 'przed czasem';
                
                alert(`üìä Podsumowanie trasy:\n\n≈örednie: ${avgMin}:${String(avgSec).padStart(2, '0')} ${sign}\nPrzejechano: ${currentStopIndex + 1}/${currentRoute.stops.length} przystank√≥w`);
            }

            currentRoute = null;
            currentStopIndex = 0;
            plannedTimes = [];
            delayHistory = [];

            document.querySelector('.running-screen').classList.remove('active');
            document.querySelector('.setup-screen').classList.add('active');
        }

        // EXPORT FUNKCJI
        window.toggleAddForm = toggleAddForm;
        window.addStop = addStop;
        window.editStop = editStop;
        window.removeStop = removeStop;
        window.saveRoute = saveRoute;
        window.editRoute = editRoute;
        window.updateRoute = updateRoute;
        window.deleteRoute = deleteRoute;
        window.startRoute = startRoute;
        window.setCurrentTime = setCurrentTime;
        window.confirmStartTime = confirmStartTime;
        window.departStop = departStop;
        window.previousStop = previousStop;
        window.endRoute = endRoute;
        window.createGroup = createGroup;
        window.createSubgroup = createSubgroup;
        window.renameGroup = renameGroup;
        window.deleteGroup = deleteGroup;
        window.toggleFolder = toggleFolder;
        window.openMoveModal = openMoveModal;
        window.closeMoveModal = closeMoveModal;
        window.moveRouteToGroup = moveRouteToGroup;
		        window.clearSearch = clearSearch;
        window.performSearch = performSearch;
    </script>
</body>
</html>
