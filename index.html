<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System MPK - Panel Kierowcy</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            padding: 15px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1f3a;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        h1 {
            color: #4fc3f7;
            margin-bottom: 25px;
            text-align: center;
            font-size: 2em;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 3px solid #4fc3f7;
            padding-bottom: 15px;
        }

        h2 {
            color: #81d4fa;
            margin: 20px 0 15px 0;
            font-size: 1.5em;
            border-bottom: 2px solid #2a3f5f;
            padding-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            border-bottom: 2px solid #2a3f5f;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background: #0f1529;
            font-size: 15px;
            color: #b0b0b0;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: #4fc3f7;
            background: #1a2035;
        }

        .tab.active {
            color: #4fc3f7;
            border-bottom-color: #4fc3f7;
            background: #1a1f3a;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #b0bec5;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="number"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #2a3f5f;
            border-radius: 6px;
            font-size: 16px;
            background: #0f1529;
            color: #e0e0e0;
            transition: all 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        select {
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 150px;
            font-family: 'Courier New', monospace;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4fc3f7;
            background: #1a2035;
        }

        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
            margin-right: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(25, 118, 210, 0.4);
        }

        button.danger {
            background: #d32f2f;
        }

        button.danger:hover {
            background: #c62828;
            box-shadow: 0 5px 20px rgba(211, 47, 47, 0.4);
        }

        button.success {
            background: #388e3c;
        }

        button.success:hover {
            background: #2e7d32;
            box-shadow: 0 5px 20px rgba(56, 142, 60, 0.4);
        }

        button.warning {
            background: #f57c00;
        }

        button.warning:hover {
            background: #ef6c00;
            box-shadow: 0 5px 20px rgba(245, 124, 0, 0.4);
        }

        button.small {
            padding: 6px 12px;
            font-size: 13px;
            margin: 0 2px;
        }

        .stops-list {
            background: #0f1529;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #2a3f5f;
        }

        .stop-item {
            background: #1a2035;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #4fc3f7;
            gap: 15px;
        }

        .stop-info {
            flex-grow: 1;
        }

        .stop-name {
            font-weight: bold;
            color: #e0e0e0;
            font-size: 16px;
        }

        .stop-name-input {
            width: 100%;
            padding: 6px 10px;
            font-size: 15px;
            margin-bottom: 5px;
        }

        .stop-time {
            color: #90a4ae;
            font-size: 13px;
            margin-top: 5px;
        }

        .stop-time-input {
            width: 80px;
            padding: 8px;
            font-size: 14px;
        }

        .stop-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .lines-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .folder-section {
            margin-bottom: 30px;
        }

        .folder-header {
            background: #0f1529;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #2a3f5f;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder-header:hover {
            border-color: #4fc3f7;
        }

        .folder-header h3 {
            color: #4fc3f7;
            font-size: 1.3em;
        }

        .folder-controls {
            display: flex;
            gap: 10px;
        }

        .line-card {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 2px solid #1976d2;
            transition: all 0.3s;
        }

        .line-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(25, 118, 210, 0.5);
        }

        .line-card h3 {
            margin-bottom: 15px;
            font-size: 1.6em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }

        .line-card p {
            margin-bottom: 8px;
            opacity: 0.95;
            font-size: 14px;
        }

        .line-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .line-actions button {
            flex: 1;
            font-size: 13px;
            padding: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1f3a;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 600px;
            width: 90%;
            border: 2px solid #2a3f5f;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin: 0 0 20px 0;
            border: none;
            color: #4fc3f7;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            margin: 0;
        }

        /* Widok aktywnej trasy */
        .route-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-top: 20px;
        }

        .route-main {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .route-header-bar {
            background: #0f1529;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #2a3f5f;
        }

        .route-header-bar h2 {
            margin: 0;
            border: none;
            font-size: 1.3em;
        }

        .clock-panel {
            background: #0f1529;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #2a3f5f;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .clock-item {
            text-align: center;
        }

        .clock-label {
            color: #90a4ae;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .clock-value {
            color: #4fc3f7;
            font-size: 2em;
            font-weight: bold;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        .timer-panel {
            background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
            color: white;
            padding: 50px 30px;
            border-radius: 12px;
            text-align: center;
            border: 3px solid #1976d2;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .current-stop-name {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .timer {
            font-size: 10em;
            font-weight: 900;
            margin: 40px 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.5);
            letter-spacing: 10px;
            line-height: 1;
        }

        .timer.green {
            color: #66bb6a;
        }

        .timer.yellow {
            color: #ffeb3b;
        }

        .timer.orange {
            color: #ff9800;
        }

        .timer.red {
            color: #f44336;
        }

        .progress-info {
            font-size: 1.5em;
            margin-top: 20px;
            opacity: 0.95;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .next-stop-btn {
            font-size: 1.6em;
            padding: 20px 50px;
            margin-top: 30px;
            background: white;
            color: #1565c0;
            font-weight: bold;
        }

        .next-stop-btn:hover {
            background: #f5f5f5;
            color: #0d47a1;
        }

        .schedule-panel {
            background: #0f1529;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #2a3f5f;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 150px);
        }

        .schedule-header {
            background: #1565c0;
            color: white;
            padding: 12px 15px;
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .schedule-table-container {
            overflow-y: auto;
            flex-grow: 1;
        }

        .schedule-table {
            width: 100%;
        }

        .schedule-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-table th {
            background: #1a2035;
            color: #4fc3f7;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #2a3f5f;
        }

        .schedule-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #2a3f5f;
            font-size: 13px;
        }

        .schedule-table tr:hover {
            background: #1a2035;
        }

        .schedule-table .current-row {
            background: #1a4d2e;
            border-left: 5px solid #66bb6a;
        }

        .schedule-table .passed-row {
            opacity: 0.4;
        }

        .add-stop-form {
            background: #0f1529;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #2a3f5f;
        }

        .add-stop-form h3 {
            margin-bottom: 15px;
            color: #81d4fa;
            font-size: 1.2em;
        }

        .inline-form {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 12px;
            align-items: end;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #607d8b;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #78909c;
        }

        .import-section {
            background: #0f1529;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #2a3f5f;
        }

        .import-section h3 {
            margin-bottom: 15px;
            color: #81d4fa;
            font-size: 1.2em;
        }

        .import-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: #2a3f5f;
        }

        .divider span {
            background: #1a1f3a;
            padding: 0 20px;
            position: relative;
            color: #90a4ae;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
        }

        /* Licznik pasa≈ºer√≥w */
        .passenger-counter {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 3px solid #4caf50;
            z-index: 998;
            min-width: 200px;
        }

        .passenger-counter.warning {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            border-color: #ff9800;
        }

        .passenger-counter.danger {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            border-color: #f44336;
        }

        .passenger-count {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .passenger-label {
            text-align: center;
            font-size: 0.9em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .passenger-change {
            position: fixed;
            top: 140px;
            left: 20px;
            background: #1a1f3a;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 2px solid #2a3f5f;
            z-index: 997;
            min-width: 200px;
            animation: slideInLeft 0.5s;
        }

        .passenger-change-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .passenger-change-item:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid #2a3f5f;
            font-weight: bold;
        }

        .passenger-change-item .label {
            color: #90a4ae;
        }

        .passenger-change-item .value {
            color: #4fc3f7;
            font-weight: bold;
        }

        .passenger-change-item.exit .value {
            color: #f44336;
        }

        .passenger-change-item.enter .value {
            color: #66bb6a;
        }

        /* Event notification */
        .event-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 2px solid #ff9800;
            max-width: 350px;
            z-index: 999;
            animation: slideInLeft 0.5s, pulse 2s infinite;
            cursor: pointer;
        }

        .event-notification h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .event-notification p {
            font-size: 14px;
            opacity: 0.95;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #2a3f5f;
            border-top: 5px solid #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: #4fc3f7;
            font-size: 1.2em;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .firebase-status.connected {
            background: #1b5e20;
            color: #a5d6a7;
            border: 2px solid #4caf50;
        }

        .firebase-status.disconnected {
            background: #b71c1c;
            color: #ef9a9a;
            border: 2px solid #f44336;
        }

        .firebase-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        .firebase-status.connected .dot {
            background: #4caf50;
        }

        .firebase-status.disconnected .dot {
            background: #f44336;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            }
            50% {
                box-shadow: 0 8px 32px rgba(255, 152, 0, 0.8);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .folder-manager {
            background: #0f1529;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2a3f5f;
        }

        @media (max-width: 1200px) {
            .route-layout {
                grid-template-columns: 1fr;
            }

            .schedule-panel {
                max-height: 400px;
            }

            .timer {
                font-size: 6em;
            }

            .current-stop-name {
                font-size: 2em;
            }
        }

        @media (max-width: 768px) {
            .inline-form {
                grid-template-columns: 1fr;
            }

            .timer {
                font-size: 4em;
            }

            .current-stop-name {
                font-size: 1.5em;
            }

            h1 {
                font-size: 1.5em;
            }

            .lines-list {
                grid-template-columns: 1fr;
            }

            .clock-panel {
                grid-template-columns: 1fr;
            }

            .passenger-counter {
                top: 10px;
                left: 10px;
                padding: 15px 20px;
            }

            .passenger-count {
                font-size: 2em;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f1529;
        }

        ::-webkit-scrollbar-thumb {
            background: #2a3f5f;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4fc3f7;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">≈ÅƒÖczenie z Firebase...</div>
    </div>

    <!-- Firebase status indicator -->
    <div id="firebaseStatus" class="firebase-status disconnected">
        <span class="dot"></span>
        <span>Firebase: ≈ÅƒÖczenie...</span>
    </div>

    <div class="container">
        <h1>üöç System MPK - Panel Kierowcy</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('lines')">üìã Lista Linii</button>
            <button class="tab" onclick="switchTab('route')">üö¶ Aktywna Trasa</button>
            <button class="tab" onclick="switchTab('create')">‚ûï Tworzenie Linii</button>
        </div>

        <!-- Zak≈Çadka: Lista Linii -->
        <div id="lines" class="tab-content active">
            <h2>Dostƒôpne Linie</h2>
            
            <!-- ZarzƒÖdzanie folderami -->
            <div class="folder-manager">
                <h3 style="color: #81d4fa; margin-bottom: 15px;">üìÅ ZarzƒÖdzanie Folderami</h3>
                <div class="inline-form">
                    <div class="form-group" style="margin: 0;">
                        <label>Nazwa Nowego Folderu:</label>
                        <input type="text" id="newFolderName" placeholder="np. Linie Dzienne, Linie Nocne">
                    </div>
                    <div></div>
                    <button onclick="createFolder()" class="success">‚ûï Dodaj Folder</button>
                </div>
            </div>

            <div id="linesList"></div>
        </div>

        <!-- Zak≈Çadka: Aktywna Trasa -->
        <div id="route" class="tab-content">
            <div id="noActiveRoute" class="empty-state">
                <h3>Brak Aktywnej Trasy</h3>
                <p>Wybierz liniƒô z listy aby rozpoczƒÖƒá kurs</p>
            </div>
            <div id="activeRoute" style="display: none;">
                <div class="route-header-bar">
                    <h2 id="routeTitle"></h2>
                    <button class="danger" onclick="stopRoute()">‚èπ Zako≈Ñcz</button>
                </div>

                <div class="clock-panel">
                    <div class="clock-item">
                        <div class="clock-label">Aktualny Czas</div>
                        <div class="clock-value" id="currentTimeDisplay">00:00:00</div>
                    </div>
                    <div class="clock-item">
                        <div class="clock-label">Przewidywany Koniec</div>
                        <div class="clock-value" id="endTimeDisplay">00:00:00</div>
                    </div>
                </div>

                <div class="route-layout">
                    <div class="route-main">
                        <div class="timer-panel">
                            <div class="current-stop-name" id="currentStopName">---</div>
                            <div class="timer green" id="timer">00:00</div>
                            <div class="progress-info" id="progressInfo">Przystanek 0 z 0</div>
                            <button class="next-stop-btn" onclick="nextStop()" id="nextStopBtn">
                                ‚èé ENTER - Odjazd
                            </button>
                        </div>
                    </div>

                    <div class="schedule-panel">
                        <div class="schedule-header">üìç Rozk≈Çad</div>
                        <div class="schedule-table-container">
                            <div class="schedule-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Przystanek</th>
                                            <th>Plan</th>
                                            <th>Prognoza</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zak≈Çadka: Tworzenie Linii -->
        <div id="create" class="tab-content">
            <h2>Utw√≥rz NowƒÖ Liniƒô</h2>

            <!-- Import z JSON -->
            <div class="import-section">
                <h3>üì• Import z JSON</h3>
                <div class="form-group">
                    <label>Wklej dane w formacie JSON:</label>
                    <textarea id="jsonImportInput" placeholder='{"Line": "1", "Destination": "Rzƒôdzin Pƒôtla", "Stops": ["Przystanek 1", "Przystanek 2"]}'></textarea>
                </div>
                <div class="import-buttons">
                    <button onclick="importFromJSON()" class="success">üì• Importuj i Edytuj</button>
                    <button onclick="document.getElementById('jsonImportInput').value = ''" class="danger">üóëÔ∏è Wyczy≈õƒá</button>
                </div>
            </div>

            <div class="divider"><span>lub</span></div>

            <!-- Rƒôczne tworzenie -->
            <div class="form-group">
                <label>Nazwa Linii / Numer:</label>
                <input type="text" id="lineName" placeholder="np. 42, A1, P√≥≈Çnocna">
            </div>

            <div class="add-stop-form">
                <h3>Dodaj Przystanki</h3>
                <div class="inline-form">
                    <div class="form-group" style="margin: 0;">
                        <label>Nazwa Przystanku:</label>
                        <input type="text" id="stopName" placeholder="np. Dworzec G≈Ç√≥wny" onkeypress="handleStopEnter(event)">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Czas (min):</label>
                        <input type="number" id="stopTime" placeholder="1" min="0" value="1" onkeypress="handleStopEnter(event)">
                    </div>
                    <button onclick="addStop()" class="success">Dodaj</button>
                </div>
                <p style="margin-top: 10px; color: #607d8b; font-size: 13px;">
                    ‚ÑπÔ∏è Naci≈õnij ENTER aby szybko dodaƒá przystanek. Dla pierwszego przystanku ustaw czas na 0.
                </p>
            </div>

            <div id="currentStops" class="stops-list" style="display: none;">
                <h3 style="color: #81d4fa; margin-bottom: 15px;">Przystanki na trasie:</h3>
                <div id="stopsContainer"></div>
            </div>

            <button onclick="saveLine()" style="margin-top: 20px; font-size: 16px;">üíæ Zapisz Liniƒô</button>
        </div>
    </div>

    <!-- Modal Start Trasy -->
    <div id="startModal" class="modal">
        <div class="modal-content">
            <h2>üö¶ Rozpocznij Kurs</h2>
            <div class="form-group">
                <label>Godzina Rozpoczƒôcia Kursu:</label>
                <input type="time" id="modalStartTime" value="" step="60">
            </div>
            <div class="form-group">
                <label>Przystanek PoczƒÖtkowy:</label>
                <select id="modalStartStop"></select>
            </div>
            <div class="form-group">
                <label>Przystanek Ko≈Ñcowy:</label>
                <select id="modalEndStop"></select>
            </div>
            <div class="modal-buttons">
                <button class="success" onclick="confirmStartRoute()">‚ñ∂Ô∏è Start</button>
                <button class="danger" onclick="closeStartModal()">‚ùå Anuluj</button>
            </div>
        </div>
    </div>

    <!-- Modal Edycji Importu -->
    <div id="importEditModal" class="modal">
        <div class="modal-content">
            <h2>‚úèÔ∏è Edytuj ZaimportowanƒÖ Liniƒô</h2>
            <div class="form-group">
                <label>Nazwa Linii:</label>
                <input type="text" id="importLineName" readonly style="background: #1a2035;">
            </div>
            <div class="form-group">
                <label>Destinacja:</label>
                <input type="text" id="importDestination" readonly style="background: #1a2035;">
            </div>
            <div class="stops-list">
                <h3 style="color: #81d4fa; margin-bottom: 15px;">Przystanki - Ustaw czasy:</h3>
                <div id="importStopsContainer"></div>
            </div>
            <div class="modal-buttons">
                <button class="success" onclick="confirmImport()">‚úÖ Zatwierd≈∫ i Zapisz</button>
                <button class="danger" onclick="closeImportEditModal()">‚ùå Anuluj</button>
            </div>
        </div>
    </div>

    <!-- Modal Przypisania do Folderu -->
    <div id="folderAssignModal" class="modal">
        <div class="modal-content">
            <h2>üìÅ Przenie≈õ do Folderu</h2>
            <div class="form-group">
                <label>Wybierz Folder:</label>
                <select id="folderSelect">
                    <option value="">Brak folderu</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="success" onclick="confirmFolderAssign()">‚úÖ Przenie≈õ</button>
                <button class="danger" onclick="closeFolderAssignModal()">‚ùå Anuluj</button>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyD3-e1xwK59tcs7Ydxem9zg0-9XZv2PdKU",
            authDomain: "geoule.firebaseapp.com",
            databaseURL: "https://geoule-default-rtdb.firebaseio.com",
            projectId: "geoule",
            storageBucket: "geoule.firebasestorage.app",
            messagingSenderId: "55343832686",
            appId: "1:55343832686:web:2b9f8c6e6659b33f01907f",
            measurementId: "G-53ZVNSPP3V"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Globalne zmienne
        let currentStops = [];
        let lines = [];
        let folders = [];
        let activeRouteData = null;
        let timerInterval = null;
        let clockInterval = null;
        let eventCheckInterval = null;
        let routeStartTime = null;
        let currentStopIndex = 0;
        let currentDelay = 0;
        let pendingLineId = null;
        let importedData = null;
        let editMode = false;
        let editLineId = null;
        let pendingFolderLineId = null;
        let routeStartStopIndex = 0;
        let routeEndStopIndex = 0;
        let passengerCount = 0;
        let firebaseConnected = false;

        // Lista losowych wydarze≈Ñ z wagami
        const randomEvents = [
            { icon: "‚ôø", title: "Osoba niepe≈Çnosprawna", text: "Pasa≈ºer prosi o wyciƒÖgniƒôcie rampy", weight: 8 },
            { icon: "üç∫", title: "Pijany pasa≈ºer", text: "Nietrze≈∫wa osoba wchodzi do autobusu", weight: 16 },
            { icon: "üò†", title: "Awantura", text: "Nastolatki g≈Ço≈õno s≈ÇuchajƒÖ muzyki i przeszkadzajƒÖ", weight: 8 },
            { icon: "üîß", title: "Wandalizm", text: "Kto≈õ bazgrze po siedzeniu", weight: 4 },
            { icon: "üé´", title: "Kontrola bilet√≥w", text: "Kontroler wchodzi do autobusu", weight: 20 },
            { icon: "üë¥", title: "Pomoc seniorowi", text: "Starszy pasa≈ºer potrzebuje pomocy przy wsiadaniu", weight: 16 },
            { icon: "üö®", title: "Alarm", text: "Kto≈õ przypadkowo nacisnƒÖ≈Ç przycisk alarmowy", weight: 4 },
            { icon: "üêï", title: "Zwierzƒô", text: "Pasa≈ºer z du≈ºym psem bez kaga≈Ñca", weight: 12 },
            { icon: "ü§¢", title: "Pasa≈ºer ≈∫le siƒô czuje", text: "Kto≈õ prosi o zatrzymanie, bo mu niedobrze", weight: 8 },
            { icon: "üì±", title: "Zgubiony telefon", text: "Znaleziono telefon na siedzeniu", weight: 4 }
        ];

        const totalWeight = randomEvents.reduce((sum, event) => sum + event.weight, 0);

        // ===== FIREBASE FUNCTIONS =====
        
        function updateFirebaseStatus(connected, message) {
            const statusEl = document.getElementById('firebaseStatus');
            statusEl.className = `firebase-status ${connected ? 'connected' : 'disconnected'}`;
            statusEl.innerHTML = `<span class="dot"></span><span>Firebase: ${message}</span>`;
            firebaseConnected = connected;
        }

        async function loadLinesFromFirebase() {
            try {
                const snapshot = await database.ref('busLines').once('value');
                const data = snapshot.val();
                return data ? (Array.isArray(data) ? data : Object.values(data)) : [];
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania linii z Firebase:', error);
                return [];
            }
        }

        async function saveLinesToFirebase() {
            try {
                await database.ref('busLines').set(lines);
                console.log('Linie zapisane do Firebase');
            } catch (error) {
                console.error('B≈ÇƒÖd zapisywania linii do Firebase:', error);
            }
        }

        async function loadFoldersFromFirebase() {
            try {
                const snapshot = await database.ref('busFolders').once('value');
                const data = snapshot.val();
                return data ? (Array.isArray(data) ? data : Object.values(data)) : [];
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania folder√≥w z Firebase:', error);
                return [];
            }
        }

        async function saveFoldersToFirebase() {
            try {
                await database.ref('busFolders').set(folders);
                console.log('Foldery zapisane do Firebase');
            } catch (error) {
                console.error('B≈ÇƒÖd zapisywania folder√≥w do Firebase:', error);
            }
        }

        async function initializeData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = loadingOverlay.querySelector('.loading-text');

            try {
                loadingText.textContent = 'Sprawdzanie Firebase...';
                
                // Sprawd≈∫ czy sƒÖ dane w Firebase
                const firebaseLines = await loadLinesFromFirebase();
                const firebaseFolders = await loadFoldersFromFirebase();
                
                const firebaseEmpty = firebaseLines.length === 0 && firebaseFolders.length === 0;
                
                if (firebaseEmpty) {
                    loadingText.textContent = 'Firebase pusty - migracja z localStorage...';
                    console.log('Firebase pusty - sprawdzam localStorage...');
                    
                    // Pobierz dane z localStorage
                    const localLinesData = localStorage.getItem('busLines');
                    const localFoldersData = localStorage.getItem('busFolders');
                    
                    if (localLinesData) {
                        lines = JSON.parse(localLinesData);
                        console.log(`Znaleziono ${lines.length} linii w localStorage`);
                    }
                    
                    if (localFoldersData) {
                        folders = JSON.parse(localFoldersData);
                        console.log(`Znaleziono ${folders.length} folder√≥w w localStorage`);
                    }
                    
                    // Prze≈õlij do Firebase je≈õli sƒÖ jakie≈õ dane
                    if (lines.length > 0 || folders.length > 0) {
                        loadingText.textContent = 'Przesy≈Çanie danych do Firebase...';
                        await saveLinesToFirebase();
                        await saveFoldersToFirebase();
                        console.log('Dane przes≈Çane do Firebase!');
                    }
                    
                    updateFirebaseStatus(true, 'Po≈ÇƒÖczono (migracja)');
                } else {
                    loadingText.textContent = 'Pobieranie danych z Firebase...';
                    console.log('Pobieranie danych z Firebase...');
                    
                    // U≈ºyj danych z Firebase
                    lines = firebaseLines;
                    folders = firebaseFolders;
                    
                    console.log(`Pobrano ${lines.length} linii i ${folders.length} folder√≥w z Firebase`);
                    updateFirebaseStatus(true, 'Po≈ÇƒÖczono');
                }
                
                // Ukryj loading overlay
                loadingOverlay.style.display = 'none';
                
                // Wy≈õwietl dane
                displayLines();
                
            } catch (error) {
                console.error('B≈ÇƒÖd inicjalizacji:', error);
                loadingText.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia - u≈ºywam localStorage...';
                updateFirebaseStatus(false, 'B≈ÇƒÖd po≈ÇƒÖczenia');
                
                // Fallback do localStorage
                loadLinesLocal();
                loadFoldersLocal();
                displayLines();
                
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 2000);
            }
        }

        // Lokalne funkcje (fallback)
        function loadLinesLocal() {
            const saved = localStorage.getItem('busLines');
            if (saved) {
                lines = JSON.parse(saved);
            }
        }

        function loadFoldersLocal() {
            const saved = localStorage.getItem('busFolders');
            if (saved) {
                folders = JSON.parse(saved);
            }
        }

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            // Inicjalizuj dane z Firebase
            initializeData();
            
            updateModalTime();
            
            // Obs≈Çuga klawisza Enter
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && activeRouteData && currentStopIndex <= routeEndStopIndex) {
                    nextStop();
                }
            });

            // Nas≈Çuchuj zmian w Firebase (real-time sync)
            database.ref('busLines').on('value', (snapshot) => {
                if (firebaseConnected) {
                    const data = snapshot.val();
                    if (data) {
                        lines = Array.isArray(data) ? data : Object.values(data);
                        displayLines();
                    }
                }
            });

            database.ref('busFolders').on('value', (snapshot) => {
                if (firebaseConnected) {
                    const data = snapshot.val();
                    if (data) {
                        folders = Array.isArray(data) ? data : Object.values(data);
                        displayLines();
                    }
                }
            });
        });

        function updateModalTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('modalStartTime').value = `${hours}:${minutes}`;
        }

        // Prze≈ÇƒÖczanie zak≈Çadek
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ===== FOLDERY =====
        function createFolder() {
            const name = document.getElementById('newFolderName').value.trim();
            if (!name) {
                alert('Podaj nazwƒô folderu!');
                return;
            }

            const folder = {
                id: Date.now(),
                name: name
            };

            folders.push(folder);
            saveFolders();
            displayLines();
            document.getElementById('newFolderName').value = '';
        }

        function deleteFolder(folderId) {
            if (!confirm('Czy na pewno usunƒÖƒá folder? Linie zostanƒÖ przeniesione do "Bez folderu".')) return;

            lines.forEach(line => {
                if (line.folderId === folderId) {
                    delete line.folderId;
                }
            });

            folders = folders.filter(f => f.id !== folderId);
            saveFolders();
            saveLines();
            displayLines();
        }

        function renameFolder(folderId) {
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;

            const newName = prompt('Nowa nazwa folderu:', folder.name);
            if (!newName || newName.trim() === '') return;

            folder.name = newName.trim();
            saveFolders();
            displayLines();
        }

        function saveFolders() {
            // Zapisz do localStorage (backup)
            localStorage.setItem('busFolders', JSON.stringify(folders));
            // Zapisz do Firebase
            saveFoldersToFirebase();
        }

        function loadFolders() {
            // Ta funkcja jest teraz obs≈Çugiwana przez initializeData()
        }

        function showFolderAssignModal(lineId) {
            pendingFolderLineId = lineId;
            const select = document.getElementById('folderSelect');
            
            let html = '<option value="">Brak folderu</option>';
            folders.forEach(folder => {
                html += `<option value="${folder.id}">${folder.name}</option>`;
            });
            select.innerHTML = html;

            const line = lines.find(l => l.id === lineId);
            if (line && line.folderId) {
                select.value = line.folderId;
            }

            document.getElementById('folderAssignModal').classList.add('show');
        }

        function closeFolderAssignModal() {
            document.getElementById('folderAssignModal').classList.remove('show');
            pendingFolderLineId = null;
        }

        function confirmFolderAssign() {
            const folderId = document.getElementById('folderSelect').value;
            const line = lines.find(l => l.id === pendingFolderLineId);
            
            if (line) {
                if (folderId) {
                    line.folderId = parseInt(folderId);
                } else {
                    delete line.folderId;
                }
                saveLines();
                displayLines();
            }

            closeFolderAssignModal();
        }

        // ===== IMPORT Z JSON =====
        function importFromJSON() {
            const jsonText = document.getElementById('jsonImportInput').value.trim();
            
            if (!jsonText) {
                alert('Wklej dane JSON!');
                return;
            }

            try {
                const data = JSON.parse(jsonText);
                
                if (!data.Line || !data.Stops || !Array.isArray(data.Stops)) {
                    alert('Nieprawid≈Çowy format JSON! Wymagane pola: Line, Stops (tablica)');
                    return;
                }

                if (data.Stops.length < 2) {
                    alert('Linia musi mieƒá co najmniej 2 przystanki!');
                    return;
                }

                importedData = {
                    line: data.Line,
                    destination: data.Destination || '',
                    stops: data.Stops.map((stopName, index) => ({
                        name: stopName,
                        time: index === 0 ? 0 : 1
                    }))
                };

                showImportEditModal();

            } catch (error) {
                alert('B≈ÇƒÖd parsowania JSON! Sprawd≈∫ format danych.\n\n' + error.message);
            }
        }

        function showImportEditModal() {
            if (!importedData) return;

            document.getElementById('importLineName').value = importedData.line;
            document.getElementById('importDestination').value = importedData.destination;

            const container = document.getElementById('importStopsContainer');
            let html = '';

            importedData.stops.forEach((stop, index) => {
                html += `
                    <div class="stop-item">
                        <div class="stop-info">
                            <div class="stop-name">${index + 1}. ${stop.name}</div>
                        </div>
                        <input type="number" 
                               class="stop-time-input" 
                               id="importTime${index}" 
                               value="${stop.time}" 
                               min="0"
                               ${index === 0 ? 'disabled' : ''}>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('importEditModal').classList.add('show');
        }

        function closeImportEditModal() {
            document.getElementById('importEditModal').classList.remove('show');
            importedData = null;
        }

        function confirmImport() {
            if (!importedData) return;

            importedData.stops.forEach((stop, index) => {
                const input = document.getElementById(`importTime${index}`);
                if (input) {
                    stop.time = parseInt(input.value) || (index === 0 ? 0 : 1);
                }
            });

            let lineName = importedData.line;
            if (importedData.destination) {
                lineName += ` ‚Üí ${importedData.destination}`;
            }

            const line = {
                id: Date.now(),
                name: lineName,
                stops: [...importedData.stops]
            };

            lines.push(line);
            saveLines();
            displayLines();

            closeImportEditModal();
            document.getElementById('jsonImportInput').value = '';
            
            alert('‚úÖ Linia zosta≈Ça zaimportowana i zapisana!');
            switchTab('lines');
            document.querySelectorAll('.tab')[0].classList.add('active');
        }

        // ===== PRZYSTANKI =====
        function handleStopEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addStop();
            }
        }

        function addStop() {
            const name = document.getElementById('stopName').value.trim();
            const time = parseInt(document.getElementById('stopTime').value) || 1;

            if (!name) {
                alert('Podaj nazwƒô przystanku!');
                return;
            }

            currentStops.push({ name, time });
            document.getElementById('stopName').value = '';
            document.getElementById('stopTime').value = '1';
            document.getElementById('stopName').focus();
            displayCurrentStops();
        }

        function displayCurrentStops() {
            const container = document.getElementById('stopsContainer');
            const currentStopsDiv = document.getElementById('currentStops');
            
            if (currentStops.length === 0) {
                currentStopsDiv.style.display = 'none';
                return;
            }

            currentStopsDiv.style.display = 'block';
            let html = '';
            let totalTime = 0;

            currentStops.forEach((stop, index) => {
                totalTime += stop.time;
                html += `
                    <div class="stop-item">
                        <div class="stop-info">
                            ${editMode ? `
                                <input type="text" 
                                       class="stop-name-input" 
                                       id="stopNameEdit${index}" 
                                       value="${stop.name}">
                                <div class="stop-time">
                                    Czas: <input type="number" 
                                                 class="stop-time-input" 
                                                 id="stopTimeEdit${index}" 
                                                 value="${stop.time}" 
                                                 min="0"
                                                 ${index === 0 ? 'disabled' : ''}>
                                    min | ≈ÅƒÖcznie: ${totalTime} min
                                </div>
                            ` : `
                                <div class="stop-name">${index + 1}. ${stop.name}</div>
                                <div class="stop-time">
                                    ${index === 0 ? 'START' : `+${stop.time} min od poprzedniego`} | ≈ÅƒÖcznie: ${totalTime} min od startu
                                </div>
                            `}
                        </div>
                        <div class="stop-actions">
                            ${editMode && index > 0 ? `<button class="small" onclick="moveStopUp(${index})">‚¨ÜÔ∏è</button>` : ''}
                            ${editMode && index < currentStops.length - 1 ? `<button class="small" onclick="moveStopDown(${index})">‚¨áÔ∏è</button>` : ''}
                            <button class="danger small" onclick="removeStop(${index})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function removeStop(index) {
            currentStops.splice(index, 1);
            displayCurrentStops();
        }

        function moveStopUp(index) {
            if (index === 0) return;
            [currentStops[index], currentStops[index - 1]] = [currentStops[index - 1], currentStops[index]];
            displayCurrentStops();
        }

        function moveStopDown(index) {
            if (index === currentStops.length - 1) return;
            [currentStops[index], currentStops[index + 1]] = [currentStops[index + 1], currentStops[index]];
            displayCurrentStops();
        }

        function updateStopsFromInputs() {
            currentStops.forEach((stop, index) => {
                const nameInput = document.getElementById(`stopNameEdit${index}`);
                const timeInput = document.getElementById(`stopTimeEdit${index}`);
                
                if (nameInput) stop.name = nameInput.value.trim();
                if (timeInput) stop.time = parseInt(timeInput.value) || (index === 0 ? 0 : 1);
            });
        }

        // ===== LINIE =====
        function saveLine() {
            const name = document.getElementById('lineName').value.trim();

            if (!name) {
                alert('Podaj nazwƒô linii!');
                return;
            }

            if (currentStops.length < 2) {
                alert('Dodaj co najmniej 2 przystanki!');
                return;
            }

            if (editMode) {
                updateStopsFromInputs();
            }

            const line = {
                id: editMode ? editLineId : Date.now(),
                name,
                stops: [...currentStops]
            };

            if (editMode) {
                const index = lines.findIndex(l => l.id === editLineId);
                if (index !== -1) {
                    line.folderId = lines[index].folderId;
                    lines[index] = line;
                }
                editMode = false;
                editLineId = null;
            } else {
                lines.push(line);
            }

            saveLines();
            
            document.getElementById('lineName').value = '';
            currentStops = [];
            displayCurrentStops();
            displayLines();

            alert('‚úÖ Linia zosta≈Ça zapisana!');
            switchTab('lines');
            document.querySelectorAll('.tab')[0].classList.add('active');
        }

        function saveLines() {
            // Zapisz do localStorage (backup)
            localStorage.setItem('busLines', JSON.stringify(lines));
            // Zapisz do Firebase
            saveLinesToFirebase();
        }

        function loadLines() {
            // Ta funkcja jest teraz obs≈Çugiwana przez initializeData()
        }

        function displayLines() {
            const container = document.getElementById('linesList');
            
            if (lines.length === 0 && folders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Brak Linii</h3>
                        <p>Przejd≈∫ do zak≈Çadki "Tworzenie Linii" aby utworzyƒá pierwszƒÖ liniƒô</p>
                    </div>
                `;
                return;
            }

            let html = '';

            const linesWithoutFolder = lines.filter(l => !l.folderId);
            if (linesWithoutFolder.length > 0) {
                html += '<div class="folder-section">';
                html += '<div class="folder-header"><h3>üìã Bez Folderu</h3></div>';
                html += '<div class="lines-list">';
                linesWithoutFolder.forEach(line => {
                    html += generateLineCard(line);
                });
                html += '</div></div>';
            }

            folders.forEach(folder => {
                const folderLines = lines.filter(l => l.folderId === folder.id);
                html += '<div class="folder-section">';
                html += `
                    <div class="folder-header">
                        <h3>üìÅ ${folder.name} (${folderLines.length})</h3>
                        <div class="folder-controls">
                            <button class="warning small" onclick="renameFolder(${folder.id})">‚úèÔ∏è Zmie≈Ñ nazwƒô</button>
                            <button class="danger small" onclick="deleteFolder(${folder.id})">üóëÔ∏è Usu≈Ñ folder</button>
                        </div>
                    </div>
                `;
                
                if (folderLines.length > 0) {
                    html += '<div class="lines-list">';
                    folderLines.forEach(line => {
                        html += generateLineCard(line);
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function generateLineCard(line) {
            const totalTime = line.stops.reduce((sum, stop) => sum + stop.time, 0);
            return `
                <div class="line-card">
                    <h3>üöç Linia ${line.name}</h3>
                    <p>üìç <strong>Przystank√≥w:</strong> ${line.stops.length}</p>
                    <p>‚è±Ô∏è <strong>Czas trasy:</strong> ${totalTime} min</p>
                    <p style="font-size: 13px; margin-top: 10px; opacity: 0.8;">
                        ${line.stops.map(s => s.name).join(' ‚Üí ')}
                    </p>
                    <div class="line-actions">
                        <button class="success" onclick="showStartModal(${line.id})">‚ñ∂Ô∏è Start</button>
                        <button class="warning" onclick="editLine(${line.id})">‚úèÔ∏è Edytuj</button>
                        <button onclick="showFolderAssignModal(${line.id})" style="background: #7b1fa2;">üìÅ</button>
                        <button class="danger" onclick="deleteLine(${line.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        function deleteLine(id) {
            if (!confirm('Czy na pewno usunƒÖƒá tƒô liniƒô?')) return;
            
            lines = lines.filter(line => line.id !== id);
            saveLines();
            displayLines();
        }

        function editLine(id) {
            const line = lines.find(l => l.id === id);
            if (!line) return;

            editMode = true;
            editLineId = id;

            document.getElementById('lineName').value = line.name;
            currentStops = JSON.parse(JSON.stringify(line.stops));
            displayCurrentStops();

            switchTab('create');
            document.querySelectorAll('.tab')[2].classList.add('active');
        }

        // ===== START TRASY =====
        function showStartModal(lineId) {
            pendingLineId = lineId;
            updateModalTime();
            
            const line = lines.find(l => l.id === lineId);
            if (!line) return;

            const startSelect = document.getElementById('modalStartStop');
            const endSelect = document.getElementById('modalEndStop');
            
            let html = '';
            line.stops.forEach((stop, index) => {
                html += `<option value="${index}">${stop.name}</option>`;
            });
            
            startSelect.innerHTML = html;
            endSelect.innerHTML = html;
            endSelect.selectedIndex = line.stops.length - 1;

            document.getElementById('startModal').classList.add('show');
        }

        function closeStartModal() {
            document.getElementById('startModal').classList.remove('show');
            pendingLineId = null;
        }

        function confirmStartRoute() {
            const startTime = document.getElementById('modalStartTime').value;
            if (!startTime) {
                alert('Podaj godzinƒô startu!');
                return;
            }

            const line = lines.find(l => l.id === pendingLineId);
            if (!line) return;

            routeStartStopIndex = parseInt(document.getElementById('modalStartStop').value);
            routeEndStopIndex = parseInt(document.getElementById('modalEndStop').value);

            if (routeStartStopIndex >= routeEndStopIndex) {
                alert('Przystanek ko≈Ñcowy musi byƒá po przystanku poczƒÖtkowym!');
                return;
            }

            const routeStops = line.stops.slice(routeStartStopIndex, routeEndStopIndex + 1);
            
            activeRouteData = {
                name: line.name,
                stops: routeStops
            };

            currentStopIndex = 0;
            currentDelay = 0;
            
            passengerCount = Math.floor(Math.random() * 6);
            
            routeStartTime = new Date();
            const [hours, minutes] = startTime.split(':');
            routeStartTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            document.getElementById('noActiveRoute').style.display = 'none';
            document.getElementById('activeRoute').style.display = 'block';
            document.getElementById('routeTitle').textContent = `Linia ${line.name}`;

            updateRouteDisplay();
            buildScheduleTable();
            startTimer();
            startClock();
            startEventChecker();
            showPassengerCounter();

            closeStartModal();
            switchTab('route');
            document.querySelectorAll('.tab')[1].classList.add('active');
        }

        function stopRoute() {
            if (!confirm('Zako≈Ñczyƒá kurs?')) return;

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (clockInterval) {
                clearInterval(clockInterval);
                clockInterval = null;
            }
            if (eventCheckInterval) {
                clearInterval(eventCheckInterval);
                eventCheckInterval = null;
            }

            const existingEvent = document.querySelector('.event-notification');
            if (existingEvent) {
                existingEvent.remove();
            }

            const existingCounter = document.querySelector('.passenger-counter');
            if (existingCounter) {
                existingCounter.remove();
            }

            const existingChange = document.querySelector('.passenger-change');
            if (existingChange) {
                existingChange.remove();
            }

            activeRouteData = null;
            currentStopIndex = 0;
            currentDelay = 0;
            passengerCount = 0;

            document.getElementById('noActiveRoute').style.display = 'block';
            document.getElementById('activeRoute').style.display = 'none';
        }

        // ===== LICZNIK PASA≈ªER√ìW =====
        function showPassengerCounter() {
            const existing = document.querySelector('.passenger-counter');
            if (existing) existing.remove();

            const counter = document.createElement('div');
            counter.className = 'passenger-counter';
            counter.innerHTML = `
                <div class="passenger-count">üë• ${passengerCount}</div>
                <div class="passenger-label">Pasa≈ºer√≥w</div>
            `;

            document.body.appendChild(counter);
            updatePassengerCounterColor();
        }

        function updatePassengerCounter() {
            const counter = document.querySelector('.passenger-counter');
            if (!counter) return;

            counter.querySelector('.passenger-count').textContent = `üë• ${passengerCount}`;
            updatePassengerCounterColor();
        }

        function updatePassengerCounterColor() {
            const counter = document.querySelector('.passenger-counter');
            if (!counter) return;

            counter.classList.remove('warning', 'danger');

            if (passengerCount >= 90) {
                counter.classList.add('danger');
            } else if (passengerCount >= 70) {
                counter.classList.add('warning');
            }
        }

        function calculatePassengerChange() {
            const totalStops = activeRouteData.stops.length;
            const progress = currentStopIndex / (totalStops - 1);

            let exiting = 0;
            let entering = 0;

            if (currentStopIndex === totalStops - 1) {
                exiting = passengerCount;
                entering = 0;
            }
            else if (currentStopIndex < 3) {
                exiting = Math.floor(Math.random() * 3);
                entering = 5 + Math.floor(Math.random() * 8);
            }
            else if (currentStopIndex >= totalStops - 3) {
                exiting = 4 + Math.floor(Math.random() * 7);
                entering = Math.floor(Math.random() * 4);
            }
            else {
                exiting = 2 + Math.floor(Math.random() * 5);
                entering = 3 + Math.floor(Math.random() * 6);
            }

            exiting = Math.min(exiting, passengerCount);

            const potentialTotal = passengerCount - exiting + entering;
            if (potentialTotal > 100) {
                entering = 100 - (passengerCount - exiting);
            }

            passengerCount = passengerCount - exiting + entering;

            showPassengerChange(exiting, entering);
            updatePassengerCounter();

            if (passengerCount >= 95 && Math.random() < 0.3) {
                setTimeout(() => {
                    showEvent({
                        icon: "üò§",
                        title: "Autobus przepe≈Çniony",
                        text: "Pasa≈ºerowie narzekajƒÖ na t≈Çok, niekt√≥rzy nie mogli wsiƒÖ≈õƒá"
                    });
                }, 2000);
            }
        }

        function showPassengerChange(exiting, entering) {
            const existing = document.querySelector('.passenger-change');
            if (existing) existing.remove();

            const change = document.createElement('div');
            change.className = 'passenger-change';
            change.innerHTML = `
                <div class="passenger-change-item exit">
                    <span class="label">‚¨áÔ∏è Wysiad≈Ço:</span>
                    <span class="value">${exiting}</span>
                </div>
                <div class="passenger-change-item enter">
                    <span class="label">‚¨ÜÔ∏è Wsiad≈Ço:</span>
                    <span class="value">${entering}</span>
                </div>
                <div class="passenger-change-item">
                    <span class="label">üë• ≈ÅƒÖcznie:</span>
                    <span class="value">${passengerCount}</span>
                </div>
            `;

            document.body.appendChild(change);

            setTimeout(() => {
                change.style.animation = 'fadeOut 0.5s';
                setTimeout(() => change.remove(), 500);
            }, 5000);
        }

        // ===== ZEGARY =====
        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            
            updateClocks();
            clockInterval = setInterval(() => {
                updateClocks();
            }, 1000);
        }

        function updateClocks() {
            const now = new Date();
            const timeStr = now.toTimeString().substr(0, 8);
            document.getElementById('currentTimeDisplay').textContent = timeStr;

            if (activeRouteData) {
                const totalPlannedTime = activeRouteData.stops.reduce((sum, stop) => sum + stop.time, 0);
                const endTime = new Date(routeStartTime.getTime() + totalPlannedTime * 60000 + currentDelay * 1000);
                const endTimeStr = endTime.toTimeString().substr(0, 8);
                document.getElementById('endTimeDisplay').textContent = endTimeStr;
            }
        }

        function updateRouteDisplay() {
            if (!activeRouteData) return;

            const stop = activeRouteData.stops[currentStopIndex];
            document.getElementById('currentStopName').textContent = stop.name;
            document.getElementById('progressInfo').textContent = 
                `Przystanek ${currentStopIndex + 1} z ${activeRouteData.stops.length}`;

            if (currentStopIndex === activeRouteData.stops.length - 1) {
                document.getElementById('nextStopBtn').textContent = 'üèÅ Zako≈Ñcz';
            } else {
                document.getElementById('nextStopBtn').textContent = '‚èé ENTER - Odjazd';
            }
        }

        function buildScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            let html = '';
            let cumulativeTime = 0;

            activeRouteData.stops.forEach((stop, index) => {
                cumulativeTime += stop.time;
                const plannedTime = new Date(routeStartTime.getTime() + cumulativeTime * 60000);
                const plannedTimeStr = plannedTime.toTimeString().substr(0, 5);

                html += `
                    <tr id="scheduleRow${index}">
                        <td style="font-weight: bold;">${stop.name}</td>
                        <td>${plannedTimeStr}</td>
                        <td id="predictedTime${index}">---</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                updateTimer();
                updateScheduleTable();
                updateClocks();
            }, 100);
        }

        function updateTimer() {
            if (!activeRouteData) return;

            const now = new Date();
            const elapsedMs = now - routeStartTime;
            
            let plannedTimeForCurrentStop = 0;
            for (let i = 0; i <= currentStopIndex; i++) {
                plannedTimeForCurrentStop += activeRouteData.stops[i].time;
            }
            
            const plannedMs = plannedTimeForCurrentStop * 60000;
            const differenceMs = elapsedMs - plannedMs;
            currentDelay = Math.floor(differenceMs / 1000);

            const absSeconds = Math.abs(currentDelay);
            const minutes = Math.floor(absSeconds / 60);
            const seconds = absSeconds % 60;
            const sign = currentDelay >= 0 ? '+' : '-';
            
            const timerElement = document.getElementById('timer');
            timerElement.textContent = `${sign}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const delayMinutes = currentDelay / 60;
            timerElement.className = 'timer ';
            
            if (delayMinutes > 5) {
                timerElement.classList.add('red');
            } else if (delayMinutes > 2) {
                timerElement.classList.add('orange');
            } else if (delayMinutes > 1) {
                timerElement.classList.add('yellow');
            } else {
                timerElement.classList.add('green');
            }
        }

        function updateScheduleTable() {
            if (!activeRouteData) return;

            let cumulativeTime = 0;

            activeRouteData.stops.forEach((stop, index) => {
                cumulativeTime += stop.time;
                const row = document.getElementById(`scheduleRow${index}`);
                const predictedCell = document.getElementById(`predictedTime${index}`);

                row.classList.remove('current-row', 'passed-row');

                if (index < currentStopIndex) {
                    row.classList.add('passed-row');
                } else if (index === currentStopIndex) {
                    row.classList.add('current-row');
                    
                    const now = new Date();
                    predictedCell.textContent = now.toTimeString().substr(0, 5);
                } else {
                    const predictedArrival = new Date(routeStartTime.getTime() + cumulativeTime * 60000 + currentDelay * 1000);
                    predictedCell.textContent = predictedArrival.toTimeString().substr(0, 5);
                }
            });
        }

        function nextStop() {
            if (!activeRouteData) return;

            if (currentStopIndex >= activeRouteData.stops.length - 1) {
                alert('üèÅ Kurs zako≈Ñczony!');
                stopRoute();
                return;
            }

            calculatePassengerChange();

            currentStopIndex++;
            updateRouteDisplay();
        }

        // ===== LOSOWE WYDARZENIA =====
        function startEventChecker() {
            if (eventCheckInterval) clearInterval(eventCheckInterval);

            eventCheckInterval = setInterval(() => {
                const chance = Math.random() * 100;
                if (chance < 5) {
                    showRandomEvent();
                }
            }, 15000);
        }

        function showRandomEvent() {
            const existing = document.querySelector('.event-notification');
            if (existing) return;

            const randomValue = Math.random() * totalWeight;
            let cumulativeWeight = 0;
            let selectedEvent = randomEvents[0];

            for (const event of randomEvents) {
                cumulativeWeight += event.weight;
                if (randomValue <= cumulativeWeight) {
                    selectedEvent = event;
                    break;
                }
            }

            showEvent(selectedEvent);
        }

        function showEvent(event) {
            const existing = document.querySelector('.event-notification');
            if (existing) return;

            const notification = document.createElement('div');
            notification.className = 'event-notification';
            notification.innerHTML = `
                <h4>${event.icon} ${event.title}</h4>
                <p>${event.text}</p>
            `;

            notification.onclick = () => {
                notification.remove();
            };

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 15000);
        }
    </script>
</body>
</html>
